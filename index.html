<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesage Vanille - Suivi quotidien</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
            min-height: 100vh;
            padding: 15px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(148, 163, 184, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(203, 213, 225, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(148, 163, 184, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            box-shadow: 
                0 8px 32px 0 rgba(15, 23, 42, 0.08),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.4);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, rgba(71, 85, 105, 0.9), rgba(51, 65, 85, 0.9));
            backdrop-filter: blur(20px);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .header h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            margin-bottom: 15px;
            position: relative;
            z-index: 2;
            font-weight: 800;
            background: linear-gradient(45deg, #fff, #f8fafc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
            position: relative;
            z-index: 2;
            font-weight: 400;
        }

        .content {
            padding: 40px;
            display: grid;
            gap: 30px;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 32px;
            border-radius: 20px;
            box-shadow: 
                0 10px 25px -5px rgba(15, 23, 42, 0.08),
                0 10px 10px -5px rgba(15, 23, 42, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .form-section:hover {
            transform: translateY(-4px);
            box-shadow: 
                0 20px 40px -10px rgba(15, 23, 42, 0.12),
                0 10px 15px -5px rgba(15, 23, 42, 0.08);
        }

        .form-section h2 {
            color: #1e293b;
            margin-bottom: 24px;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .form-section h2::after {
            content: '';
            flex: 1;
            height: 3px;
            background: linear-gradient(90deg, #64748b, transparent);
            border-radius: 2px;
        }

        .form-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-group input, 
        .form-group select {
            padding: 16px 20px;
            border: 2px solid rgba(203, 213, 225, 0.8);
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #334155;
        }

        .form-group input:focus, 
        .form-group select:focus {
            border-color: #64748b;
            outline: none;
            box-shadow: 
                0 0 0 4px rgba(100, 116, 139, 0.1),
                0 4px 12px rgba(100, 116, 139, 0.15);
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 1);
        }

        .form-group input::placeholder {
            color: #94a3b8;
            font-weight: 400;
        }

        .btn {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.25);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(100, 116, 139, 0.35);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            box-shadow: 0 4px 15px rgba(15, 23, 42, 0.25);
        }

        .btn.secondary:hover {
            box-shadow: 0 8px 25px rgba(15, 23, 42, 0.35);
        }

        .btn.danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.25);
        }

        .btn.danger:hover {
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.35);
        }

        .btn.success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.25);
        }

        .btn.success:hover {
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.35);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
            backdrop-filter: blur(10px);
            padding: 32px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 
                0 10px 25px -5px rgba(15, 23, 42, 0.08),
                0 10px 10px -5px rgba(15, 23, 42, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #64748b, #0f172a, #475569, #334155);
            background-size: 300% 300%;
            animation: gradient 3s ease infinite;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 20px 40px -10px rgba(15, 23, 42, 0.12),
                0 10px 15px -5px rgba(15, 23, 42, 0.08);
        }

        .stat-card h3 {
            color: #1e293b;
            font-size: 3rem;
            margin-bottom: 12px;
            font-weight: 800;
            background: linear-gradient(135deg, #64748b, #0f172a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-card p {
            color: #64748b;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 
                0 10px 25px -5px rgba(15, 23, 42, 0.08),
                0 10px 10px -5px rgba(15, 23, 42, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-height: 600px;
            overflow-y: auto;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: rgba(241, 245, 249, 0.5);
        }

        .table-container::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.5);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 116, 139, 0.7);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, rgba(71, 85, 105, 0.9), rgba(51, 65, 85, 0.9));
            backdrop-filter: blur(10px);
            color: white;
            padding: 20px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        td {
            padding: 20px;
            border-bottom: 1px solid rgba(241, 245, 249, 0.8);
            transition: all 0.3s ease;
            vertical-align: middle;
            font-weight: 500;
            color: #334155;
        }

        tr:hover td {
            background: rgba(248, 250, 252, 0.8);
            transform: scale(1.01);
        }

        .edit-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-right: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.25);
        }

        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.35);
        }

        .delete-btn {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.25);
        }

        .delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(220, 38, 38, 0.35);
        }

        .filter-section {
            margin-bottom: 24px;
        }

        .filter-section input {
            width: 100%;
            max-width: 400px;
            padding: 16px 20px;
            border: 2px solid rgba(203, 213, 225, 0.8);
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #334155;
        }

        .filter-section input:focus {
            border-color: #64748b;
            outline: none;
            box-shadow: 
                0 0 0 4px rgba(100, 116, 139, 0.1),
                0 4px 12px rgba(100, 116, 139, 0.15);
            transform: translateY(-2px);
        }

        .success-message, .error-message {
            padding: 16px 24px;
            border-radius: 12px;
            margin: 16px 0;
            font-weight: 600;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .success-message {
            background: rgba(220, 252, 231, 0.9);
            color: #065f46;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.15);
        }

        .error-message {
            background: rgba(254, 226, 226, 0.9);
            color: #991b1b;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15);
        }

        .import-export-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(15, 23, 42, 0.25);
            display: block;
            text-align: center;
            width: 100%;
        }

        .file-input-label:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(15, 23, 42, 0.35);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            margin: 15% auto;
            padding: 32px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .modal h3 {
            color: #1e293b;
            margin-bottom: 24px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal .form-group {
            margin-bottom: 20px;
        }

        .modal .btn {
            margin-right: 10px;
            margin-top: 10px;
        }

        .close {
            color: #64748b;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #dc2626;
        }

        /* CORRECTION: Styles pour la recherche d'employ√© am√©lior√©e avec z-index plus √©lev√© */
        .employee-search-container {
            position: relative;
            z-index: 100; /* Augment√© pour √©viter les superpositions */
        }

        .employee-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(100, 116, 139, 0.2);
            border-radius: 16px;
            box-shadow: 
                0 15px 35px -5px rgba(15, 23, 42, 0.2),
                0 15px 20px -5px rgba(15, 23, 42, 0.15);
            z-index: 9999; /* Z-index tr√®s √©lev√© pour passer au-dessus de tout */
            max-height: 250px; /* Hauteur r√©duite pour √©viter les d√©bordements */
            overflow-y: auto;
            margin-top: 4px;
        }

        .employee-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .employee-dropdown::-webkit-scrollbar-track {
            background: rgba(241, 245, 249, 0.5);
        }

        .employee-dropdown::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.5);
            border-radius: 3px;
        }

        .employee-dropdown::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 116, 139, 0.7);
        }

        .employee-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(241, 245, 249, 0.3);
            color: #334155;
            font-weight: 500;
        }

        .employee-option:last-child {
            border-bottom: none;
        }

        .employee-option:hover {
            background: rgba(100, 116, 139, 0.1);
            color: #1e293b;
            transform: translateX(4px);
        }

        .employee-option.selected {
            background: rgba(100, 116, 139, 0.15);
            color: #1e293b;
            font-weight: 600;
        }

        .employee-option.no-results {
            padding: 16px;
            text-align: center;
            color: #94a3b8;
            font-style: italic;
            cursor: default;
        }

        .employee-option.no-results:hover {
            background: transparent;
            transform: none;
        }

        /* CORRECTION: Statistiques avec calcul correct par date */
        .daily-summary {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 20px;
            box-shadow: 
                0 10px 25px -5px rgba(15, 23, 42, 0.08),
                0 10px 10px -5px rgba(15, 23, 42, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 20px;
        }

        .daily-summary h3 {
            color: #1e293b;
            margin-bottom: 16px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .daily-total {
            font-size: 1.5rem;
            font-weight: 800;
            color: #059669;
            text-align: center;
            padding: 16px;
            background: rgba(220, 252, 231, 0.5);
            border-radius: 12px;
            border: 2px solid rgba(5, 150, 105, 0.2);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .form-section {
                padding: 24px;
            }
            
            .form-group {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .stat-card {
                padding: 24px;
            }
            
            .table-container {
                max-height: 400px;
            }
            
            th, td {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .edit-btn, .delete-btn {
                padding: 8px 16px;
                font-size: 0.8rem;
                margin: 2px;
            }

            .import-export-section {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 24px;
            }

            /* Ajustements mobile pour la liste d√©roulante */
            .employee-dropdown {
                max-height: 200px;
                box-shadow: 
                    0 10px 25px -5px rgba(15, 23, 42, 0.15),
                    0 10px 15px -5px rgba(15, 23, 42, 0.1);
            }
        }

        /* Animation d'entr√©e */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-section, .stat-card {
            animation: slideInUp 0.6s ease-out;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        /* Fen√™tre modale de paiement am√©lior√©e */

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            margin: 5% auto;
            padding: 32px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal h3 {
            color: #1e293b;
            margin-bottom: 24px;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal .form-group {
            margin-bottom: 20px;
        }

        .modal .btn {
            margin-right: 10px;
            margin-top: 10px;
        }

        .close {
            color: #64748b;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: all 0.3s ease;
        }

        .close:hover {
            color: #dc2626;
            transform: rotate(90deg);
        }

        /* Styles pour les cartes d'employ√© am√©lior√©es */
        .employee-stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 20px;
            box-shadow: 
                0 10px 25px -5px rgba(15, 23, 42, 0.08),
                0 10px 10px -5px rgba(15, 23, 42, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .employee-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #16a34a, #059669, #047857);
            background-size: 300% 300%;
            animation: gradient 3s ease infinite;
        }

        .employee-stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 20px 40px -10px rgba(15, 23, 42, 0.15),
                0 10px 15px -5px rgba(15, 23, 42, 0.1);
        }

        .employee-name-header {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #64748b;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .stat-value {
            color: #1e293b;
            font-weight: 700;
            font-size: 1rem;
        }

        .payment-history {
            margin-top: 16px;
            padding: 12px;
            background: rgba(241, 245, 249, 0.5);
            border-radius: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .payment-item:last-child {
            margin-bottom: 0;
        }

        .payment-actions {
            display: flex;
            gap: 8px;
        }

        .payment-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .payment-edit-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .payment-delete-btn {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }

        .payment-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .salary-summary {
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
            border-radius: 12px;
            border: 2px solid rgba(16, 185, 129, 0.2);
        }

        .salary-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-weight: 600;
        }

        .salary-total {
            color: #059669;
            font-size: 1.2rem;
        }

        .salary-paid {
            color: #0ea5e9;
        }

        .salary-remaining {
            color: #dc2626;
            font-size: 1.1rem;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .action-buttons .btn {
            flex: 1;
            margin: 0;
        }

        .modal-info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .modal-info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-weight: 600;
        }

        .modal-input-group {
            margin-bottom: 20px;
        }

        .modal-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #475569;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .modal-input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(203, 213, 225, 0.8);
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .modal-input-group input:focus {
            border-color: #16a34a;
            outline: none;
            box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.1);
        }

        /* ‚≠ê NOUVEAU: Styles pour statistiques quotidiennes par qualit√© */
        /* FILTRE PERSONNALISABLE */
        .filter-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 12px;
            border: 2px solid rgba(59, 130, 246, 0.1);
            margin-bottom: 20px;
        }

        .filter-inputs input {
            width: 100%;
        }

        .highlight-over {
            background: rgba(220, 38, 38, 0.1) !important;
            border: 2px solid rgba(220, 38, 38, 0.3) !important;
            font-weight: 700 !important;
        }

        .highlight-under {
            background: rgba(22, 163, 74, 0.1) !important;
            border: 2px solid rgba(22, 163, 74, 0.3) !important;
            font-weight: 700 !important;
        }

        .out-of-range-list {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
        }

        .out-of-range-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .over-item {
            background: rgba(220, 38, 38, 0.08);
            border: 2px solid rgba(220, 38, 38, 0.2);
        }

        .under-item {
            background: rgba(22, 163, 74, 0.08);
            border: 2px solid rgba(22, 163, 74, 0.2);
        }
        .daily-quality-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 
                0 10px 25px -5px rgba(15, 23, 42, 0.08),
                0 10px 10px -5px rgba(15, 23, 42, 0.04);
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .daily-quality-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--quality-gradient, linear-gradient(90deg, #059669, #047857));
            background-size: 300% 300%;
            animation: gradient 3s ease infinite;
        }

        .daily-quality-card:hover {
            transform: translateY(-4px);
            box-shadow: 
                0 20px 40px -10px rgba(15, 23, 42, 0.15),
                0 10px 15px -5px rgba(15, 23, 42, 0.1);
        }

        .quality-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            background: var(--badge-bg, rgba(5, 150, 105, 0.1));
            color: var(--badge-color, #059669);
            border: 1px solid var(--badge-border, rgba(5, 150, 105, 0.2));
        }

       /* ‚≠ê NOUVEAU: dark mode */ 
       :root {
            --bg-primary: #f8fafc;
            --bg-secondary: white;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
        }

        /* Fond de la carte salaire */
        [data-theme="dark"] .salary-summary {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.18), rgba(5, 150, 105, 0.18));
            border: 2px solid rgba(16, 185, 129, 0.35);
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.4);
        }

        /* Labels noirs */
        [data-theme="dark"] .salary-row span:first-child {
            color: #111827 !important;  /* noir/gris anthracite profond */
            font-weight: 700;
        }

        /* Valeurs color√©es √† droite */
        [data-theme="dark"] .salary-total {
            color: #22c55e !important;  /* vert vif */
            font-weight: 700;
        }

        [data-theme="dark"] .salary-paid {
            color: #0ea5e9 !important;  /* bleu vif */
            font-weight: 700;
        }

        [data-theme="dark"] .salary-remaining {
            color: #ef4444 !important;  /* rouge vif */
            font-weight: 700;
        }

        /* Texte g√©n√©ral */
        [data-theme="dark"] .salary-row {
            color: var(--text-primary) !important;
        }


        /* ‚≠ê SYST√àME D'ALERTE EMPLOY√â */
        .employee-alert-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(217, 119, 6, 0.15));
            border: 2px solid rgba(245, 158, 11, 0.4);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #d97706;
            margin-left: 8px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .employee-alert-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.98));
            backdrop-filter: blur(20px);
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(245, 158, 11, 0.3);
            border: 3px solid rgba(245, 158, 11, 0.5);
            max-width: 500px;
            width: 90%;
            z-index: 10000;
            animation: alertSlideIn 0.3s ease;
        }

        @keyframes alertSlideIn {
            from {
                transform: translate(-50%, -60%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }

        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 9999;
        }

        .alert-icon {
            font-size: 4rem;
            text-align: center;
            margin-bottom: 20px;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .alert-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #d97706;
            text-align: center;
            margin-bottom: 16px;
        }

        .alert-message {
            background: rgba(245, 158, 11, 0.1);
            padding: 16px;
            border-radius: 12px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            margin-bottom: 20px;
            font-size: 1.05rem;
            font-weight: 600;
            color: #92400e;
            text-align: center;
            line-height: 1.6;
        }

        .alert-note-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(203, 213, 225, 0.8);
            border-radius: 12px;
            font-size: 0.95rem;
            margin-bottom: 20px;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .alert-actions {
            display: flex;
            gap: 12px;
        }

        .alert-btn-ok {
            flex: 1;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .alert-btn-ok:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }


        body {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="glass-card">
            <div class="header">
                <h1>üåø Pesage Vanille BEHAVANA</h1>
                <p>Syst√®me de suivi intelligent des poids et statistiques des employ√©s</p>
            </div>

            <div class="content">
                <!-- Ajout d'un nouvel employ√© -->
                <div class="form-section">
                    <h2>üë§ Ajouter un Nouvel Employ√©</h2>
                    <div class="success-message" id="employeeSuccessMsg">Employ√© ajout√© avec succ√®s!</div>
                    <div class="error-message" id="employeeErrorMsg">Une erreur s'est produite!</div>
                    <div class="form-group">
                        <input type="text" id="employeeName" placeholder="Nom de l'employ√©" required>
                        <button class="btn" onclick="addEmployee()">Ajouter Employ√©</button>
                    </div>
                </div>

                <!-- Gestion des employ√©s -->
                <div class="form-section">
                    <h2>üë• Gestion des Employ√©s</h2>
                    <div style="display:flex; gap:8px; margin:8px 0;">
                        <input id="employeeManageSearch" 
                            type="text" 
                            placeholder="üîç Rechercher..." 
                            oninput="filterManageEmployees()" 
                            style="flex:1; padding:8px; border-radius:6px; border:1px solid #ccc;">
                        
                        <button onclick="clearEmployeeManageSearch()" 
                            style="padding:8px 12px; border-radius:6px; background:#f43f5e; color:white; border:none;">
                            ‚úñÔ∏è
                        </button>
                    </div>


                    <div class="success-message" id="employeeManagementSuccessMsg">Op√©ration r√©ussie!</div>
                    <div class="error-message" id="employeeManagementErrorMsg">Une erreur s'est produite!</div>
                    <div class="table-container">
                        <table id="employeesTable">
                            <thead>
                                <tr>
                                    <th>üë§ Nom Employ√©</th>
                                    <th>üìÖ Date d'ajout</th>
                                    <th>üìä Nombre de pesages</th>
                                    <th>üõ†Ô∏è Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employeesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ‚≠ê NOUVEAU: Prix par d√©faut pour anciennes donn√©es -->
                <div class="form-section">
                    <h2>üí∞ Prix par D√©faut (pour anciennes donn√©es sans qualit√©)</h2>
                    <div class="success-message" id="defaultPriceSuccessMsg">Prix par d√©faut mis √† jour!</div>
                    <div class="error-message" id="defaultPriceErrorMsg">Erreur!</div>
                    
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 20px; border-radius: 12px; border: 2px solid rgba(59, 130, 246, 0.2); margin-bottom: 20px;">
                        <p style="color: #1e40af; font-weight: 600; margin-bottom: 16px;">
                            ‚ÑπÔ∏è Ce prix sera utilis√© uniquement pour les pesages anciens qui n'ont pas de qualit√© d√©finie.
                        </p>
                        <div class="form-group">
                            <input type="text" id="defaultPricePerKg" placeholder="Prix par d√©faut (Ar)" onkeyup="formatDefaultPriceInput()" required>
                            <button class="btn success" onclick="updateDefaultPrice()">üíæ Enregistrer Prix par D√©faut</button>
                        </div>
                        <div style="margin-top: 16px; padding: 16px; background: rgba(255, 255, 255, 0.8); border-radius: 8px;">
                            <p style="color: #1e293b; font-weight: 600; font-size: 1.1rem; text-align: center;">
                                Prix actuel: <span id="currentDefaultPrice" style="font-size: 1.3rem; font-weight: 800; color: #059669;">0 Ar</span> / kg
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Statistiques g√©n√©rales -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalEmployees">0</h3>
                        <p>Total Employ√©s</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalWeights">0</h3>
                        <p>Total Pesages</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="todayWeights">0</h3>
                        <p>Pesages Aujourd'hui</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="monthlyTotal">0 kg</h3>
                        <p>Total du Mois</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="overallTotal">0 kg</h3>
                        <p>Total G√©n√©ral</p>
                    </div>
                </div>

                <!-- Statistiques des salaires -->
                <div class="form-section">
                    <h2>üíµ Calcul des Salaires</h2>
                    
                    <!-- Totaux g√©n√©raux -->
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));">
                            <h3 id="totalSalary" style="background: linear-gradient(135deg, #059669, #047857); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">0 Ar</h3>
                            <p>Total Salaires √† Payer</p>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1));">
                            <h3 id="monthlySalary" style="background: linear-gradient(135deg, #3b82f6, #2563eb); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">0 Ar</h3>
                            <p>Salaires du Mois</p>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));">
                            <h3 id="todaySalary" style="background: linear-gradient(135deg, #f59e0b, #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">0 Ar</h3>
                            <p>Salaires Aujourd'hui</p>
                        </div>
                    </div>
                    
                    <!-- ‚≠ê NOUVEAU: R√©partition par Qualit√© -->
                    <div style="background: rgba(59, 130, 246, 0.05); padding: 20px; border-radius: 16px; border: 2px solid rgba(59, 130, 246, 0.1);">
                        <h3 style="color: #1e293b; margin-bottom: 16px; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                            üíé R√©partition des Salaires par Qualit√©
                        </h3>
                        <div id="salaryByQualityGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px;">
                            <!-- Cartes g√©n√©r√©es dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- Saisie du poids quotidien -->
                <div class="form-section">
                    <h2>‚öñÔ∏è Enregistrement du Pesage</h2>
                    <div class="success-message" id="weightSuccessMsg">Poids enregistr√© avec succ√®s!</div>
                    <div class="error-message" id="weightErrorMsg">Une erreur s'est produite!</div>
                    <div class="form-group">
                        <div class="employee-search-container" style="position: relative; z-index: 100;">
                            <input type="text" id="employeeSearchInput" placeholder="Rechercher un employ√© ou taper son nom..." 
                                autocomplete="off" onkeyup="searchEmployees()" onfocus="showEmployeeDropdown()" 
                                style="width: 100%;">
                            <div id="employeeDropdown" class="employee-dropdown" style="display: none;">
                            </div>
                            <input type="hidden" id="selectedEmployeeId" value="">
                        </div>
                        <input type="number" id="weight" placeholder="Poids (kg)" step="0.1" min="0" required>
                        <input type="date" id="weighingDate" required>
                        <input type="text" id="qualityName" placeholder="üíé Nom de la qualit√© (ex: Premium, Standard...)" required>
                        <input type="text" id="qualityPrice" placeholder="üí∞ Prix par kg (Ar)" onkeyup="formatQualityPriceInputField()" required>
                        <button class="btn" onclick="addWeight()" style="grid-column: 1 / -1;">Enregistrer Pesage</button>
                        <button class="btn secondary" onclick="fillLastEntry()" style="grid-column: 1 / -1;">
                            üîÑ Reprendre derni√®re saisie (qualit√© + prix)
                        </button>

                    </div>
                </div>

                <!-- ‚≠ê NOUVEAU: Statistiques Quotidiennes par Qualit√© -->
                <!-- ‚≠ê NOUVEAU: Statistiques Quotidiennes par Qualit√© AM√âLIOR√âES -->
                <div class="form-section">
                    <h2>üìÖ Statistiques Quotidiennes par Qualit√©</h2>

                    <!-- ‚≠ê RECHERCHE INTELLIGENTE EMPLOY√â -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #64748b; font-weight: 600; font-size: 0.9rem;">
                            üîç Rechercher un Employ√©
                        </label>
                        <div style="position: relative; z-index: 100;">
                            <input type="text" 
                                id="dailyStatsEmployeeSearch" 
                                placeholder="Tapez le nom de l'employ√©..." 
                                autocomplete="off"
                                onkeyup="filterDailyStatsByEmployee()"
                                onfocus="showDailyStatsEmployeeDropdown()"
                                style="width: 100%; padding: 16px 20px; border: 2px solid rgba(203, 213, 225, 0.8); border-radius: 16px; font-size: 1rem; font-weight: 500; background: rgba(255, 255, 255, 0.9);">
                            <div id="dailyStatsEmployeeDropdown" class="employee-dropdown" style="display: none; max-width: 100%;"></div>
                            <input type="hidden" id="selectedDailyStatsEmployeeId" value="">
                        </div>
                        <div id="selectedEmployeeInfo" style="display: none; margin-top: 12px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; border: 2px solid rgba(59, 130, 246, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #1e40af; font-weight: 600;">
                                    üë§ Filtr√© par: <strong id="selectedEmployeeNameDisplay"></strong>
                                </span>
                                <button onclick="clearDailyStatsEmployeeFilter()" 
                                        style="background: rgba(220, 38, 38, 0.1); color: #dc2626; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                    ‚úï Effacer
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NOUVEAU: Filtres personnalisables -->
                    <div class="filter-inputs">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #64748b; font-weight: 600; font-size: 0.9rem;">
                                ‚¨áÔ∏è Poids Minimum (kg)
                            </label>
                            <input type="number" id="minWeightFilter" placeholder="Ex: 3" step="0.1" min="0">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #64748b; font-weight: 600; font-size: 0.9rem;">
                                ‚¨ÜÔ∏è Poids Maximum (kg)
                            </label>
                            <input type="number" id="maxWeightFilter" placeholder="Ex: 10" step="0.1" min="0">
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <input type="date" id="dailyStatsDate" required>
                        <button class="btn" onclick="updateDailyQualityStats()">üîç Afficher Statistiques du Jour</button>
                        <button class="btn secondary" onclick="showTodayStats()">üìÜ Aujourd'hui</button>
                    </div>
                    
                    <div id="dailyQualityStatsContainer" style="display: none;">
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 16px; border-radius: 12px; border: 2px solid rgba(59, 130, 246, 0.2); margin-bottom: 20px;">
                            <h3 style="color: #1e40af; margin-bottom: 12px; font-size: 1.1rem;">
                                üìÖ Date: <span id="selectedDateDisplay"></span>
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
                                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: 800; color: #059669;" id="dailyTotalKg">0 kg</div>
                                    <div style="color: #64748b; font-size: 0.9rem; font-weight: 600;">Poids Total</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: 800; color: #3b82f6;" id="dailyTotalSalary">0 Ar</div>
                                    <div style="color: #64748b; font-size: 0.9rem; font-weight: 600;">Salaire Total</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: 800; color: #f59e0b;" id="dailyTotalPesages">0</div>
                                    <div style="color: #64748b; font-size: 0.9rem; font-weight: 600;">Pesages</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; border: 2px solid rgba(220, 38, 38, 0.2);">
                                    <div style="font-size: 1.5rem; font-weight: 800; color: #dc2626;" id="dailyMinWeight">0 kg</div>
                                    <div style="color: #64748b; font-size: 0.9rem; font-weight: 600;">‚¨áÔ∏è Poids Min</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px; border: 2px solid rgba(22, 163, 74, 0.2);">
                                    <div style="font-size: 1.5rem; font-weight: 800; color: #16a34a;" id="dailyMaxWeight">0 kg</div>
                                    <div style="color: #64748b; font-size: 0.9rem; font-weight: 600;">‚¨ÜÔ∏è Poids Max</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- NOUVEAU: Listes des poids hors limites -->
                        <div id="outOfRangeLists" style="display: none;" class="out-of-range-list">
                            <div id="overLimitList" style="display: none; margin-bottom: 20px;">
                                <h3 style="color: #dc2626; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    ‚ö†Ô∏è Poids SUP√âRIEURS √† <span id="displayMaxLimit">0</span> kg
                                </h3>
                                <div id="overLimitItems"></div>
                            </div>
                            
                            <div id="underLimitList" style="display: none;">
                                <h3 style="color: #16a34a; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    ‚ÑπÔ∏è Poids INF√âRIEURS √† <span id="displayMinLimit">0</span> kg
                                </h3>
                                <div id="underLimitItems"></div>
                            </div>
                        </div>
                        
                        <div id="dailyQualityBreakdown" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                            <!-- Cartes g√©n√©r√©es dynamiquement -->
                        </div>
                        
                        <!-- Tableau d√©taill√© -->
                        <div style="margin-top: 24px;">
                            <h3 style="color: #1e293b; margin-bottom: 16px; font-size: 1.2rem;">üìã D√©tail des Pesages</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>üë§ Employ√©</th>
                                            <th>üíé Qualit√©</th>
                                            <th>‚öñÔ∏è Poids (kg)</th>
                                            <th>üí∞ Prix/kg (Ar)</th>
                                            <th>üíµ Salaire (Ar)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dailyQualityTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="noDailyData" style="display: none; text-align: center; padding: 40px; color: #94a3b8;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">üì≠</div>
                        <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 8px;">Aucun pesage pour cette date</div>
                        <div style="font-size: 0.95rem;">S√©lectionnez une autre date ou enregistrez des pesages</div>
                    </div>
                </div>

                <!-- Recherche et filtrage -->
                <div class="form-section">
                    <h2>üîç Recherche et Filtrage Avanc√©</h2>
                    <div class="filter-section">
                        <div class="employee-search-container" style="position: relative; z-index: 50;">
                            <input type="text" id="nameFilter" placeholder="Rechercher par nom d'employ√©..." 
                                autocomplete="off" onkeyup="filterEmployeeSearch()" onfocus="showFilterEmployeeDropdown()" 
                                style="width: 100%; max-width: 400px;">
                            <div id="filterEmployeeDropdown" class="employee-dropdown" style="display: none; max-width: 400px;">
                            </div>
                            <input type="hidden" id="selectedFilterEmployeeId" value="">
                        </div>
                    </div>
                    <div class="form-group">
                        <select id="monthFilter" onchange="filterByMonth()">
                            <option value="">Filtrer par mois</option>
                            <option value="01">Janvier</option>
                            <option value="02">F√©vrier</option>
                            <option value="03">Mars</option>
                            <option value="04">Avril</option>
                            <option value="05">Mai</option>
                            <option value="06">Juin</option>
                            <option value="07">Juillet</option>
                            <option value="08">Ao√ªt</option>
                            <option value="09">Septembre</option>
                            <option value="10">Octobre</option>
                            <option value="11">Novembre</option>
                            <option value="12">D√©cembre</option>
                        </select>
                        <input type="date" id="dateFilter" placeholder="Filtrer par date" onchange="filterByDate()">
                        <button class="btn secondary" onclick="clearFilters()">üîÑ Effacer Filtres</button>
                    </div>
                    
                    <!-- NOUVEAU: R√©sum√© quotidien avec total correct -->
                    <div id="dailySummary" class="daily-summary" style="display: none;">
                        <h3>üìä R√©sum√© pour la date s√©lectionn√©e</h3>
                        <div class="daily-total" id="dailyTotal">
                            0 kg
                        </div>
                        <p style="text-align: center; margin-top: 12px; color: #64748b;">
                            Total des pesages: <span id="dailyCount">0</span> pesage(s)
                        </p>
                    </div>
                    <!-- NOUVEAU: Statistiques des r√©sultats de recherche -->
                    <div id="searchStats" class="daily-summary" style="display: none;">
                        <h3>üìä Statistiques des R√©sultats de Recherche</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                            <div style="text-align: center; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; border: 2px solid rgba(59, 130, 246, 0.2);">
                                <div style="font-size: 1.5rem; font-weight: 800; color: #1e40af;" id="searchTotalWeight">0 kg</div>
                                <div style="color: #64748b; font-size: 0.9rem; font-weight: 600;">Poids Total</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border: 2px solid rgba(16, 185, 129, 0.2);">
                                <div style="font-size: 1.5rem; font-weight: 800; color: #047857;" id="searchAverage">0 kg</div>
                                <div style="color: #64748b; font-size: 0.9rem; font-weight: 600;">Moyenne</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 12px; border: 2px solid rgba(245, 158, 11, 0.2);">
                                <div style="font-size: 1.5rem; font-weight: 800; color: #d97706;" id="searchCount">0</div>
                                <div style="color: #64748b; font-size: 0.9rem; font-weight: 600;">Nombre de Pesages</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn secondary" onclick="exportData()">üìä Exporter CSV</button>
                        <button class="btn danger" onclick="clearAllData()">üóëÔ∏è R√©initialiser</button>
                    </div>
                </div>

                <!-- Import/Export JSON Section -->
                <div class="form-section">
                    <h2>üíæ Importation et Exportation JSON</h2>
                    <div class="success-message" id="importSuccessMsg">Donn√©es import√©es avec succ√®s!</div>
                    <div class="error-message" id="importErrorMsg">Erreur lors de l'importation!</div>
                    <!-- ‚≠ê NOUVEAU: Bouton DEBUG -->
                    <div style="margin-bottom: 20px; padding: 16px; background: rgba(245, 158, 11, 0.1); border-radius: 12px; border: 2px solid rgba(245, 158, 11, 0.2);">
                        <h3 style="color: #d97706; margin-bottom: 12px; font-size: 1.1rem;">üîç V√©rification Base de Donn√©es</h3>
                        <button class="btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);" onclick="debugDatabase()">
                            üîç Afficher contenu BDD dans Console
                        </button>
                        <p style="color: #92400e; margin-top: 8px; font-size: 0.9rem;">
                            Appuyez sur F12 ‚Üí Console pour voir les r√©sultats
                        </p>
                    </div>
                    
                    <div class="import-export-section">
                    <div class="import-export-section">
                        <div class="file-input-wrapper">
                            <input type="file" id="jsonFileInput" accept=".json" onchange="importJSON()">
                            <label for="jsonFileInput" class="file-input-label">üì• Importer JSON</label>
                        </div>
                        <button class="btn success" onclick="exportJSON()">üì§ Exporter JSON</button>
                        <button class="btn danger" onclick="resetAllData()">üîÑ Remise √† Z√©ro</button>
                    </div>
                </div>

                <!-- Liste des pesages -->
                <div class="form-section">
                    <h2>üìä Liste des Pesages</h2>
                    <div class="table-container">
                        <table id="weightsTable">
                            <thead>
                                <tr>
                                    <th>üìÖ Date</th>
                                    <th>üë§ Nom Employ√©</th>
                                    <th>‚öñÔ∏è Poids (kg)</th>
                                    <th>üíé Qualit√©</th>
                                    <th>üõ†Ô∏è Actions</th>
                                </tr>
                            </thead>
                            <tbody id="weightsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Statistiques par employ√© -->
                <div class="form-section">
                    <h2>üìà Statistiques D√©taill√©es par Employ√©</h2>
                    <input type="text" id="employeeStatsSearch" 
                        placeholder="üîç Rechercher un employ√©..."
                        onkeyup="filterEmployeeStats()" 
                        style="padding:14px 20px; width:100%; max-width:400px; 
                                border:2px solid rgba(203,213,225,0.8);
                                border-radius:12px; margin-bottom:20px; 
                                font-size:1rem; font-weight:500;">
                    
                    <div id="employeeStats"
                        style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
                                gap:24px; max-height:500px; overflow-y:auto; padding:10px;">
                    </div>
                </div>


                <!-- Tableau d√©taill√© des salaires par employ√© -->
                <div class="form-section">
                    <h2>üíº D√©tail des Salaires par Employ√©</h2>
                    <div class="table-container">
                        <table id="salaryTable">
                            <thead>
                                <tr>
                                    <th>üë§ Nom Employ√©</th>
                                    <th>‚öñÔ∏è Poids Total (kg)</th>
                                    <th>üìä Nombre Pesages</th>
                                    <th>üí∞ Salaire Total (Ar)</th>
                                    <th>üìÖ Salaire du Mois (Ar)</th>
                                </tr>
                            </thead>
                            <tbody id="salaryTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            
            </div>
        </div>
    </div>

    <!-- Modal pour modifier un employ√© -->
    <div id="editEmployeeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditEmployeeModal()">&times;</span>
            <h3>‚úèÔ∏è Modifier l'Employ√©</h3>
            <div class="form-group">
                <input type="text" id="editEmployeeName" placeholder="Nouveau nom de l'employ√©" required>
            </div>
            <button class="btn" onclick="saveEmployeeChanges()">Sauvegarder</button>
            <button class="btn secondary" onclick="closeEditEmployeeModal()">Annuler</button>
        </div>
    </div>

    <!-- Fen√™tre modale de paiement am√©lior√©e -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePaymentModal()">&times;</span>
            <h3>üí∏ Enregistrer un Paiement</h3>
            
            <div class="modal-info-box">
                <div class="modal-info-item">
                    <span style="color: #64748b;">üë§ Employ√©:</span>
                    <span id="paymentEmployeeName" style="color: #1e293b; font-weight: 700;"></span>
                </div>
                <div class="modal-info-item">
                    <span style="color: #059669;">üí∞ Salaire Total:</span>
                    <span id="paymentTotalSalary" style="color: #059669;"></span>
                </div>
                <div class="modal-info-item">
                    <span style="color: #0ea5e9;">‚úÖ D√©j√† Pay√©:</span>
                    <span id="paymentAlreadyPaid" style="color: #0ea5e9;"></span>
                </div>
                <div class="modal-info-item" style="border-top: 2px solid rgba(220, 38, 38, 0.2); padding-top: 12px; margin-top: 8px;">
                    <span style="color: #dc2626;">‚ö†Ô∏è Reste √† Payer:</span>
                    <span id="paymentRemaining" style="color: #dc2626; font-size: 1.2rem; font-weight: 800;"></span>
                </div>
            </div>

            <div class="modal-input-group">
                <label for="paymentAmount">üíµ Montant √† Payer (Ar)</label>
                <input type="number" id="paymentAmount" placeholder="Entrez le montant" min="0" step="100">
            </div>

            <div class="modal-input-group">
                <label for="paymentDate">üìÖ Date du Paiement</label>
                <input type="date" id="paymentDate">
            </div>

            <div class="modal-input-group">
                <label for="paymentNote">üìù Note (optionnel)</label>
                <input type="text" id="paymentNote" placeholder="Ex: Avance, Paiement partiel...">
            </div>

            <div class="action-buttons">
                <button class="btn secondary" onclick="closePaymentModal()">‚ùå Annuler</button>
                <button class="btn success" onclick="confirmPayment()">‚úÖ Valider Paiement</button>
            </div>
        </div>
    </div>

    <!-- ‚≠ê NOUVEAU: Modal D√©tail Poids par Employ√© -->
    <div id="employeeWeightsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeEmployeeWeightsModal()">&times;</span>
            <h3>‚öñÔ∏è D√©tail des Pesages - <span id="weightsModalEmployeeName"></span></h3>
            
            <!-- R√©sum√© rapide -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; padding: 16px; background: rgba(59, 130, 246, 0.05); border-radius: 12px; border: 2px solid rgba(59, 130, 246, 0.1);">
                <div style="text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: 800; color: #059669;" id="modalTotalWeight">0 kg</div>
                    <div style="color: #64748b; font-size: 0.85rem; font-weight: 600;">Poids Total</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: 800; color: #3b82f6;" id="modalTotalPesages">0</div>
                    <div style="color: #64748b; font-size: 0.85rem; font-weight: 600;">Pesages</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: 800; color: #f59e0b;" id="modalAvgWeight">0 kg</div>
                    <div style="color: #64748b; font-size: 0.85rem; font-weight: 600;">Moyenne</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: 800; color: #16a34a;" id="modalTotalSalary">0 Ar</div>
                    <div style="color: #64748b; font-size: 0.85rem; font-weight: 600;">Salaire Total</div>
                </div>
            </div>
            
            <!-- Filtres -->
            <div class="form-group" style="margin-bottom: 20px;">
                <input type="month" id="modalMonthFilter" onchange="filterModalWeights()" placeholder="Filtrer par mois">
                <select id="modalQualityFilter" onchange="filterModalWeights()">
                    <option value="">Toutes les qualit√©s</option>
                </select>
                <button class="btn secondary" onclick="clearModalFilters()">üîÑ Effacer Filtres</button>
            </div>
            
            <!-- Tableau d√©taill√© avec scroll -->
            <div class="table-container" style="max-height: 400px;">
                <table>
                    <thead>
                        <tr>
                            <th>üìÖ Date</th>
                            <th>üíé Qualit√©</th>
                            <th>‚öñÔ∏è Poids (kg)</th>
                            <th>üí∞ Prix/kg (Ar)</th>
                            <th>üíµ Salaire (Ar)</th>
                            <th>üõ†Ô∏è Actions</th>
                        </tr>
                    </thead>
                    <tbody id="employeeWeightsTableBody">
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn secondary" onclick="closeEmployeeWeightsModal()">Fermer</button>
                <button class="btn" onclick="exportEmployeeWeights()">üìä Exporter CSV</button>
            </div>
        </div>
    </div>

    <!-- Modal pour modifier un paiement -->
    <div id="editPaymentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditPaymentModal()">&times;</span>
            <h3>‚úèÔ∏è Modifier le Paiement</h3>
            
            <div class="modal-input-group">
                <label for="editPaymentAmount">üíµ Montant (Ar)</label>
                <input type="number" id="editPaymentAmount" min="0" step="100">
            </div>

            <div class="modal-input-group">
                <label for="editPaymentDate">üìÖ Date</label>
                <input type="date" id="editPaymentDate">
            </div>

            <div class="modal-input-group">
                <label for="editPaymentNote">üìù Note</label>
                <input type="text" id="editPaymentNote" placeholder="Note...">
            </div>

            <div class="action-buttons">
                <button class="btn secondary" onclick="closeEditPaymentModal()">‚ùå Annuler</button>
                <button class="btn success" onclick="savePaymentChanges()">üíæ Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- ‚≠ê MODAL ALERTE EMPLOY√â -->
    <div id="employeeAlertOverlay" class="alert-overlay" style="display: none;" onclick="closeEmployeeAlert()"></div>
    <div id="employeeAlertModal" class="employee-alert-modal" style="display: none;">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div class="alert-title">ATTENTION!</div>
        <div class="alert-message" id="alertMessageContent"></div>
        <div style="text-align: center; margin-bottom: 16px; font-size: 0.9rem; color: #64748b;">
            Employ√©: <strong id="alertEmployeeName" style="color: #1e293b; font-size: 1.1rem;"></strong>
        </div>
        <div class="alert-actions">
            <button class="alert-btn-ok" onclick="closeEmployeeAlert()">
                ‚úì J'ai compris
            </button>
        </div>
    </div>

    <!-- Theme Toggle Button -->
    <button id="themeToggleBtn" class="theme-toggle-btn" onclick="toggleDarkMode()">
        üåô Dark Mode
    </button>

    <script>
        // Configuration IndexedDB
        let db;
        const dbName = 'VanillaWeighingDB';
        const dbVersion = 3; // ‚¨ÖÔ∏è Incr√©ment√© pour ajouter le store des prix
        let currentEditingEmployeeId = null;
        let currentPricePerKg = 0; // ‚¨ÖÔ∏è Variable pour stocker le prix actuel

        // Variables globales pour la recherche d'employ√©s
        let allEmployees = [];
        let selectedEmployeeIndex = -1;

        // ‚≠ê NOUVEAU: Debug database pour v√©rifier les donn√©es
        const debugDatabase = () => {
            if (!db) {
                console.error('‚ùå Base de donn√©es pas encore initialis√©e!');
                alert('‚ö†Ô∏è Base de donn√©es pas encore pr√™te. Patientez...');
                return;
            }
            
            console.log('üîç ===== D√âBUT V√âRIFICATION BDD =====');
            
            const transaction = db.transaction(['weights', 'employees', 'payments'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const employeeStore = transaction.objectStore('employees');
            const paymentStore = transaction.objectStore('payments');
            
            const weightRequest = weightStore.getAll();
            const employeeRequest = employeeStore.getAll();
            const paymentRequest = paymentStore.getAll();
            
            Promise.all([
                new Promise(resolve => { weightRequest.onsuccess = () => resolve(weightRequest.result); }),
                new Promise(resolve => { employeeRequest.onsuccess = () => resolve(employeeRequest.result); }),
                new Promise(resolve => { paymentRequest.onsuccess = () => resolve(paymentRequest.result); })
            ]).then(([weights, employees, payments]) => {
                console.log('üë• EMPLOY√âS (' + employees.length + '):', employees);
                console.log('‚öñÔ∏è PESAGES (' + weights.length + '):', weights);
                console.log('üí∞ PAIEMENTS (' + payments.length + '):', payments);
                
                // V√©rifier dates
                console.log('\nüìÖ DATES DES PESAGES:');
                weights.forEach((w, i) => {
                    const emp = employees.find(e => e.id === w.employeeId);
                    console.log(`  ${i+1}. ${w.date} - ${emp?.name || 'Inconnu'} - ${w.weight}kg - Note: "${w.note}"`);
                });
                
                console.log('\nüîç ===== FIN V√âRIFICATION =====');
                alert('‚úÖ V√©rification termin√©e! Consultez la Console (F12)');
            });
        };

        // ‚≠ê NOUVEAU: Formater l'input du prix par d√©faut
        const formatDefaultPriceInput = () => {
            const input = document.getElementById('defaultPricePerKg');
            if (!input) return;
            
            let value = input.value.replace(/\s/g, '');
            if (value === '') return;
            
            value = value.replace(/\D/g, '');
            if (value) {
                value = parseInt(value).toLocaleString('fr-FR');
                input.value = value;
            }
        };

        // ‚≠ê NOUVEAU: Mettre √† jour le prix par d√©faut
        const updateDefaultPrice = () => {
            if (!db) {
                showMessage('defaultPriceErrorMsg', 'La base de donn√©es n\'est pas encore pr√™te. Veuillez patienter...');
                return;
            }

            const priceInput = document.getElementById('defaultPricePerKg').value;
            if (!priceInput) {
                showMessage('defaultPriceErrorMsg', 'Le prix est obligatoire!');
                return;
            }

            const price = parseFloat(priceInput.replace(/\s/g, ''));
            
            if (isNaN(price) || price <= 0) {
                showMessage('defaultPriceErrorMsg', 'Prix invalide!');
                return;
            }

            const transaction = db.transaction(['prices'], 'readwrite');
            const store = transaction.objectStore('prices');
            const priceData = {
                price: price,
                date: new Date().toISOString(),
                active: true
            };
            
            const request = store.add(priceData);
            
            request.onsuccess = () => {
                currentPricePerKg = price;
                document.getElementById('currentDefaultPrice').textContent = price.toLocaleString('fr-FR') + ' Ar';
                showMessage('defaultPriceSuccessMsg', 'Prix par d√©faut mis √† jour avec succ√®s!');
                updateStats();
                updateSalaryStats();
                updateEmployeeStats();
            };
            
            request.onerror = () => {
                showMessage('defaultPriceErrorMsg', 'Erreur lors de la mise √† jour du prix!');
            };
        };

        // ‚≠ê NOUVEAU: Charger le prix par d√©faut actuel
        const loadDefaultPrice = () => {
            const transaction = db.transaction(['prices'], 'readonly');
            const store = transaction.objectStore('prices');
            const request = store.getAll();
            
            request.onsuccess = () => {
                const prices = request.result;
                if (prices.length > 0) {
                    const lastPrice = prices[prices.length - 1];
                    currentPricePerKg = lastPrice.price;
                    document.getElementById('currentDefaultPrice').textContent = currentPricePerKg.toLocaleString('fr-FR') + ' Ar';
                    document.getElementById('defaultPricePerKg').value = currentPricePerKg.toLocaleString('fr-FR');
                }
            };
        };

        // ‚≠ê NOUVEAU: Formater l'input du prix dans le formulaire
        const formatQualityPriceInputField = () => {
            const input = document.getElementById('qualityPrice');
            if (!input) return;
            
            let value = input.value.replace(/\s/g, '');
            if (value === '') return;
            
            value = value.replace(/\D/g, '');
            if (value) {
                value = parseInt(value).toLocaleString('fr-FR');
                input.value = value;
            }
        };

        // Initialisation de la base de donn√©es
        const initDB = () => {
            const request = indexedDB.open(dbName, dbVersion);
            
            request.onerror = (event) => {
                console.error('Erreur de base de donn√©es:', event.target.error);
                alert('ERREUR: Impossible d\'initialiser la base de donn√©es!');
            };
            
            request.onsuccess = (event) => {
                db = event.target.result;
                console.log('Base de donn√©es initialis√©e avec succ√®s');
                loadDefaultPrice();
                loadAllEmployees();
                loadWeights();
                updateStats();
                loadEmployeeManagement();
                setTimeout(updateEmployeeStats, 1000);
            };
            
            request.onupgradeneeded = (event) => {
                db = event.target.result;

                // Cr√©ation des stores s'ils n'existent pas
                if (!db.objectStoreNames.contains('employees')) {
                    const employeeStore = db.createObjectStore('employees', { keyPath: 'id', autoIncrement: true });
                    employeeStore.createIndex('name', 'name', { unique: true });
                }

                if (!db.objectStoreNames.contains('weights')) {
                    const weightStore = db.createObjectStore('weights', { keyPath: 'id', autoIncrement: true });
                    weightStore.createIndex('employeeId', 'employeeId', { unique: false });
                }

                if (!db.objectStoreNames.contains('prices')) {
                    db.createObjectStore('prices', { keyPath: 'id', autoIncrement: true });
                }

                if (!db.objectStoreNames.contains('payments')) {
                    const paymentStore = db.createObjectStore('payments', { keyPath: 'id', autoIncrement: true });
                    paymentStore.createIndex('employeeId', 'employeeId', { unique: false });
                }

            }; // ‚úÖ mihidy tsara eto ny onupgradeneeded
        }; // ‚úÖ mihidy koa ny initDB()
 


        // Ajouter un nouvel employ√©
        const addEmployee = () => {
            if (!db) {
                showMessage('employeeErrorMsg', 'La base de donn√©es n\'est pas encore pr√™te. Veuillez patienter...');
                return;
            }

            const name = document.getElementById('employeeName').value.trim();
            if (!name) {
                showMessage('employeeErrorMsg', 'Le nom est obligatoire!');
                return;
            }

            const transaction = db.transaction(['employees'], 'readwrite');
            const store = transaction.objectStore('employees');
            const employee = { 
                name: name, 
                createdAt: new Date().toISOString(),
                alertNote: '' // ‚≠ê NOUVEAU
            };
            
            const request = store.add(employee);
            
            request.onsuccess = () => {
                document.getElementById('employeeName').value = '';
                showMessage('employeeSuccessMsg', 'Employ√© ajout√© avec succ√®s!');
                loadAllEmployees();
                updateStats();
                updateSalaryStats();
                loadEmployeeManagement();
            };
            
            request.onerror = () => {
                showMessage('employeeErrorMsg', 'Cet employ√© existe d√©j√† ou une erreur s\'est produite!');
            };
        };

        // Charger tous les employ√©s en m√©moire
        const loadAllEmployees = () => {
            const transaction = db.transaction(['employees'], 'readonly');
            const store = transaction.objectStore('employees');
            const request = store.getAll();
            
            request.onsuccess = () => {
                allEmployees = request.result.sort((a, b) => a.name.localeCompare(b.name));
            };
        };

        // Afficher la liste d√©roulante des employ√©s avec gestion am√©lior√©e de z-index
        const showEmployeeDropdown = () => {
            const dropdown = document.getElementById('employeeDropdown');
            const searchInput = document.getElementById('employeeSearchInput');
            
            if (allEmployees.length === 0) {
                dropdown.innerHTML = '<div class="employee-option no-results">Aucun employ√© trouv√©</div>';
            } else {
                displayEmployeeOptions(allEmployees);
            }
            
            // S'assurer que la liste est visible avec un z-index √©lev√©
            dropdown.style.display = 'block';
            dropdown.style.zIndex = '9999';
        };

        // Rechercher des employ√©s avec gestion am√©lior√©e du positionnement
        const searchEmployees = () => {
            const searchTerm = document.getElementById('employeeSearchInput').value.toLowerCase();
            const dropdown = document.getElementById('employeeDropdown');
            const searchInput = document.getElementById('employeeSearchInput');
            selectedEmployeeIndex = -1;
            
            if (searchTerm === '') {
                showEmployeeDropdown();
                return;
            }
            
            const filteredEmployees = allEmployees.filter(employee => 
                employee.name.toLowerCase().includes(searchTerm)
            );
            
            displayEmployeeOptions(filteredEmployees);
            
            // CORRECTION: Meilleur calcul de position pour √©viter les superpositions
            const rect = searchInput.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const spaceBelow = viewportHeight - rect.bottom;
            const dropdownMaxHeight = 250;
            
            // Toujours afficher vers le bas mais ajuster la hauteur si n√©cessaire
            dropdown.style.top = '100%';
            dropdown.style.bottom = 'auto';
            dropdown.style.marginTop = '4px';
            dropdown.style.marginBottom = '0';
            dropdown.style.zIndex = '9999';
            
            // Ajuster la hauteur maximale si pas assez d'espace
            if (spaceBelow < dropdownMaxHeight + 20) {
                dropdown.style.maxHeight = Math.max(150, spaceBelow - 20) + 'px';
            } else {
                dropdown.style.maxHeight = dropdownMaxHeight + 'px';
            }
            
            dropdown.style.display = 'block';
        };

        // Afficher les options d'employ√©s
        const displayEmployeeOptions = (employees) => {
            const dropdown = document.getElementById('employeeDropdown');
            
            if (employees.length === 0) {
                dropdown.innerHTML = '<div class="employee-option no-results">Aucun employ√© trouv√©</div>';
            } else {
                dropdown.innerHTML = employees.map((employee, index) => 
                    `<div class="employee-option" onclick="selectEmployee(${employee.id}, '${employee.name}', ${index})" 
                          data-index="${index}">
                        ${employee.name}
                    </div>`
                ).join('');
            }
        };

        // S√©lectionner un employ√©
        const selectEmployee = (id, name, index = -1) => {
            document.getElementById('employeeSearchInput').value = name;
            document.getElementById('selectedEmployeeId').value = id;
            document.getElementById('employeeDropdown').style.display = 'none';
            selectedEmployeeIndex = index;
        };

        // Navigation au clavier dans la liste
        const handleEmployeeKeyNavigation = (event) => {
            const dropdown = document.getElementById('employeeDropdown');
            const options = dropdown.querySelectorAll('.employee-option:not(.no-results)');
            
            if (options.length === 0) return;
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                selectedEmployeeIndex = (selectedEmployeeIndex + 1) % options.length;
                updateSelectedOption(options);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                selectedEmployeeIndex = selectedEmployeeIndex <= 0 ? options.length - 1 : selectedEmployeeIndex - 1;
                updateSelectedOption(options);
            } else if (event.key === 'Enter' && selectedEmployeeIndex >= 0) {
                event.preventDefault();
                const selectedOption = options[selectedEmployeeIndex];
                const employeeName = selectedOption.textContent.trim();
                const employeeId = allEmployees.find(emp => emp.name === employeeName)?.id;
                if (employeeId) {
                    selectEmployee(employeeId, employeeName, selectedEmployeeIndex);
                }
            } else if (event.key === 'Escape') {
                dropdown.style.display = 'none';
                selectedEmployeeIndex = -1;
            }
        };

        // Mettre √† jour l'option s√©lectionn√©e visuellement
        const updateSelectedOption = (options) => {
            options.forEach((option, index) => {
                option.classList.toggle('selected', index === selectedEmployeeIndex);
            });
            
            if (selectedEmployeeIndex >= 0 && options[selectedEmployeeIndex]) {
                options[selectedEmployeeIndex].scrollIntoView({ block: 'nearest' });
            }
        };

        // Charger la gestion des employ√©s
        const loadEmployeeManagement = () => {
            const transaction = db.transaction(['employees', 'weights'], 'readonly');
            const employeeStore = transaction.objectStore('employees');
            const weightStore = transaction.objectStore('weights');
            
            const employeeRequest = employeeStore.getAll();
            const weightRequest = weightStore.getAll();
            
            Promise.all([
                new Promise(resolve => { employeeRequest.onsuccess = () => resolve(employeeRequest.result); }),
                new Promise(resolve => { weightRequest.onsuccess = () => resolve(weightRequest.result); })
            ]).then(([employees, weights]) => {
                const tbody = document.getElementById('employeesTableBody');
                tbody.innerHTML = '';
                
                employees.forEach(employee => {
                    const employeeWeights = weights.filter(w => w.employeeId === employee.id);
                    const row = document.createElement('tr');
                    
                    // Badge alerte si note existe
                    const alertBadge = employee.alertNote ? 
                        `<span class="employee-alert-badge" title="${employee.alertNote}">‚ö†Ô∏è Alerte</span>` : '';
                    
                    row.innerHTML = `
                        <td>
                            ${employee.name}
                            ${alertBadge}
                        </td>
                        <td>${new Date(employee.createdAt).toLocaleDateString('fr-FR')}</td>
                        <td>${employeeWeights.length}</td>
                        <td>
                            <button class="edit-btn" onclick="editEmployeeNote(${employee.id}, '${employee.name}', \`${employee.alertNote || ''}\`)">
                                üìù Note
                            </button>
                            <button class="edit-btn" onclick="editEmployee(${employee.id}, '${employee.name}')">‚úèÔ∏è Modifier</button>
                            <button class="delete-btn" onclick="deleteEmployee(${employee.id}, '${employee.name}')">üóëÔ∏è Supprimer</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        };

        function filterManageEmployees() {
            const term = document.getElementById('employeeManageSearch').value
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');

            const rows = document.querySelectorAll('#employeesTableBody tr');

            rows.forEach(row => {
                const cell = row.querySelector('td:first-child');
                const name = cell.textContent.toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '');

                if (name.includes(term)) {
                    row.style.display = '';
                    // Highlight
                    const regex = new RegExp(`(${term})`, 'gi');
                    cell.innerHTML = cell.textContent.replace(regex, '<span style="background:yellow; font-weight:bold;">$1</span>');
                } else {
                    row.style.display = 'none';
                }
            });
        }


        function clearEmployeeManageSearch() {
            document.getElementById('employeeManageSearch').value = '';
            loadEmployeeManagement();
        }



        // Modifier un employ√©
        const editEmployee = (id, name) => {
            currentEditingEmployeeId = id;
            document.getElementById('editEmployeeName').value = name;
            document.getElementById('editEmployeeModal').style.display = 'block';
        };

        // Sauvegarder les modifications d'un employ√©
        const saveEmployeeChanges = () => {
            const newName = document.getElementById('editEmployeeName').value.trim();
            if (!newName) {
                showMessage('employeeManagementErrorMsg', 'Le nom est obligatoire!');
                return;
            }

            const transaction = db.transaction(['employees'], 'readwrite');
            const store = transaction.objectStore('employees');
            
            const getRequest = store.get(currentEditingEmployeeId);
            getRequest.onsuccess = () => {
                const employee = getRequest.result;
                if (employee) {
                    employee.name = newName;
                    employee.updatedAt = new Date().toISOString();
                    
                    const updateRequest = store.put(employee);
                    updateRequest.onsuccess = () => {
                        closeEditEmployeeModal();
                        showMessage('employeeManagementSuccessMsg', 'Employ√© modifi√© avec succ√®s!');
                        loadAllEmployees();
                        loadEmployeeManagement();
                        loadWeights();
                        updateSalaryStats();
                        updateEmployeeStats();
                    };
                    updateRequest.onerror = () => {
                        showMessage('employeeManagementErrorMsg', 'Erreur lors de la modification!');
                    };
                }
            };
        };

        // Fermer le modal de modification
        const closeEditEmployeeModal = () => {
            document.getElementById('editEmployeeModal').style.display = 'none';
            currentEditingEmployeeId = null;
        };

        // Supprimer un employ√©
        const deleteEmployee = (id, name) => {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'employ√© "${name}"?\n\nATTENTION: Tous les pesages associ√©s √† cet employ√© seront √©galement supprim√©s!`)) {
                return;
            }

            const transaction = db.transaction(['employees', 'weights'], 'readwrite');
            const employeeStore = transaction.objectStore('employees');
            const weightStore = transaction.objectStore('weights');
            
            // Supprimer tous les pesages de cet employ√©
            const weightIndex = weightStore.index('employeeId');
            const weightRequest = weightIndex.openCursor(IDBKeyRange.only(id));
            
            weightRequest.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    cursor.delete();
                    cursor.continue();
                } else {
                    // Supprimer l'employ√© apr√®s avoir supprim√© tous ses pesages
                    const deleteRequest = employeeStore.delete(id);
                    deleteRequest.onsuccess = () => {
                        showMessage('employeeManagementSuccessMsg', `Employ√© "${name}" supprim√© avec succ√®s!`);
                        loadAllEmployees();
                        loadEmployeeManagement();
                        loadWeights();
                        updateStats();
                        updateSalaryStats();
                        updateEmployeeStats();
                    };
                    deleteRequest.onerror = () => {
                        showMessage('employeeManagementErrorMsg', 'Erreur lors de la suppression!');
                    };
                }
            };
        };

        // Ajouter un poids
        const addWeight = async () => { // ‚≠ê async
            if (!db) {
                showMessage('weightErrorMsg', 'La base de donn√©es n\'est pas encore pr√™te. Veuillez patienter...');
                return;
            }
            const employeeId = document.getElementById('selectedEmployeeId').value;
            const weight = document.getElementById('weight').value;
            const date = document.getElementById('weighingDate').value;
            const qualityName = document.getElementById('qualityName').value.trim();
            const qualityPriceStr = document.getElementById('qualityPrice').value.replace(/\s/g, '');
            
            if (!employeeId || !weight || !date || !qualityName || !qualityPriceStr) {
                showMessage('weightErrorMsg', 'Tous les champs sont obligatoires!');
                return;
            }

            const qualityPrice = parseFloat(qualityPriceStr);
            if (isNaN(qualityPrice) || qualityPrice < 0) {
                showMessage('weightErrorMsg', 'Prix invalide!');
                return;
            }

            // ‚≠ê V√âRIFIER ALERTE
            const employeeName = document.getElementById('employeeSearchInput').value;
            await checkEmployeeAlert(parseInt(employeeId), employeeName);

            const transaction = db.transaction(['weights'], 'readwrite');
            const store = transaction.objectStore('weights');
            
            const noteData = `${qualityName}|${qualityPrice}`;
            
            const weightData = {
                employeeId: parseInt(employeeId),
                weight: parseFloat(weight),
                date: date,
                note: noteData,
                createdAt: new Date().toISOString()
            };
            
            const request = store.add(weightData);
            
            request.onsuccess = () => {
                document.getElementById('weight').value = '';
                document.getElementById('weighingDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('qualityName').value = '';
                document.getElementById('qualityPrice').value = '';
                document.getElementById('employeeSearchInput').value = '';
                document.getElementById('selectedEmployeeId').value = '';
                document.getElementById('employeeDropdown').style.display = 'none';
                showMessage('weightSuccessMsg', 'Poids enregistr√© avec succ√®s!');
                loadWeights();
                updateStats();
                updateSalaryStats();
                updateEmployeeStats();
                loadEmployeeManagement();
                updateDailySummary();
                updateDailyQualityStats();
            };
            
            request.onerror = () => {
                showMessage('weightErrorMsg', 'Erreur lors de l\'enregistrement!');
            };
        };

        // Charger la liste des poids
        const loadWeights = () => {
            const transaction = db.transaction(['weights', 'employees'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const employeeStore = transaction.objectStore('employees');
            
            const request = weightStore.getAll();
            
            request.onsuccess = () => {
                const weights = request.result;
                const employeeRequests = [];
                
                // R√©cup√©rer les noms des employ√©s
                weights.forEach(weight => {
                    const empRequest = employeeStore.get(weight.employeeId);
                    employeeRequests.push(new Promise((resolve) => {
                        empRequest.onsuccess = () => {
                            weight.employeeName = empRequest.result ? empRequest.result.name : 'Inconnu';
                            resolve();
                        };
                    }));
                });
                
                Promise.all(employeeRequests).then(() => {
                    displayWeights(weights.reverse()); // Afficher les plus r√©cents en premier
                    // NOUVEAU: Masquer les statistiques de recherche lors du chargement complet
                    document.getElementById('searchStats').style.display = 'none';
                });
            };
        };

        // ‚≠ê NOUVEAU: R√©cup√©rer le prix selon la qualit√© (stock√©e dans note)
        const getPriceForWeight = (weightRecord) => {
            // Nouveau format: "NomQualit√©|Prix"
            if (weightRecord.note && weightRecord.note.includes('|')) {
                const parts = weightRecord.note.split('|');
                const price = parseFloat(parts[1]);
                return isNaN(price) ? 0 : price;
            }
            // ‚≠ê FALLBACK: Utiliser ancien prix global pour donn√©es taloha
            return currentPricePerKg;
        };

        // ‚≠ê NOUVEAU: R√©cup√©rer le nom de la qualit√©
        const getQualityName = (weightRecord) => {
            // Nouveau format: "NomQualit√©|Prix"
            if (weightRecord.note && weightRecord.note.includes('|')) {
                const parts = weightRecord.note.split('|');
                return parts[0];
            }
            return weightRecord.note || 'Non sp√©cifi√©e';
        };

        // ‚≠ê NOUVEAU: R√©cup√©rer prix + qualit√© format√©s avec ic√¥ne
        const getQualityDisplay = (weightRecord) => {
            const qualityName = getQualityName(weightRecord);
            const price = getPriceForWeight(weightRecord);
            
            // V√©rifier si c'est une ancienne donn√©e (utilise prix par d√©faut)
            const isOldData = !weightRecord.note || !weightRecord.note.includes('|');
            
            // Choisir ic√¥ne et couleur selon le prix
            let icon = 'üíé';
            let color = '#059669';
            
            if (price >= 500) {
                icon = '‚≠ê';
                color = '#d97706';
            } else if (price >= 400) {
                icon = 'üíé';
                color = '#059669';
            } else if (price >= 300) {
                icon = '‚úì';
                color = '#3b82f6';
            } else if (price > 0) {
                icon = '‚óã';
                color = '#64748b';
            } else {
                icon = '‚ùì';
                color = '#94a3b8';
            }
            
            if (price > 0) {
                const priceLabel = isOldData ? '(Prix par d√©faut: ' : '(';
                return `<span style="color: ${color};">${icon}</span> ${qualityName} <span style="color: ${color}; font-weight: 700;">${priceLabel}${price.toLocaleString('fr-FR')} Ar/kg)</span>`;
            }
            return `${icon} ${qualityName}`;
        };

        // Afficher les poids dans le tableau
        const displayWeights = (weights) => {
            const tbody = document.getElementById('weightsTableBody');
            
            if (!tbody) {
                console.error('Element weightsTableBody introuvable!');
                return;
            }
            
            tbody.innerHTML = '';
            
            weights.forEach(weight => {
                const row = document.createElement('tr');
                
                const qualityDisplay = getQualityDisplay(weight);
                const price = getPriceForWeight(weight);
                const salary = (weight.weight * price).toLocaleString('fr-FR');
                
                row.innerHTML = `
                    <td>${new Date(weight.date).toLocaleDateString('fr-FR')}</td>
                    <td style="font-weight: 600;">${weight.employeeName}</td>
                    <td style="font-weight: 700; color: #1e293b;">${weight.weight} kg</td>
                    <td style="max-width: 300px;">
                        <div style="background: linear-gradient(135deg, rgba(5, 150, 105, 0.08), rgba(16, 185, 129, 0.08)); 
                                    padding: 8px 14px; border-radius: 10px; display: inline-block;
                                    border: 1.5px solid rgba(5, 150, 105, 0.15);
                                    font-weight: 600; font-size: 0.95rem;">
                            ${qualityDisplay}
                        </div>
                        ${price > 0 ? `<div style="font-size: 0.85rem; color: #64748b; margin-top: 4px; font-weight: 500;">
                            üí∞ Salaire: <span style="color: #059669; font-weight: 700;">${salary} Ar</span>
                        </div>` : ''}
                    </td>
                    <td>
                        <button class="edit-btn" onclick="editWeight(${weight.id})">‚úèÔ∏è Modifier</button>
                        <button class="delete-btn" onclick="deleteWeight(${weight.id})">üóëÔ∏è Supprimer</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            applyThousandSeparators();
        };

        // Modifier un poids
        const editWeight = (id) => {
            const transaction = db.transaction(['weights', 'employees'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const employeeStore = transaction.objectStore('employees');
            
            const request = weightStore.get(id);
            
            request.onsuccess = () => {
                const weight = request.result;
                if (!weight) return;
                
                const empRequest = employeeStore.get(weight.employeeId);
                empRequest.onsuccess = () => {
                    const employee = empRequest.result;
                    
                    // Extraire qualit√© et prix actuels
                    let currentQuality = '';
                    let currentPrice = '';
                    if (weight.note && weight.note.includes('|')) {
                        const parts = weight.note.split('|');
                        currentQuality = parts[0];
                        currentPrice = parts[1];
                    }
                    
                    const newWeight = prompt(`Modifier le poids pour ${employee ? employee.name : 'Inconnu'}:`, weight.weight);
                    if (newWeight === null) return;
                    
                    const newDate = prompt('Modifier la date (YYYY-MM-DD):', weight.date);
                    if (newDate === null) return;
                    
                    const newQuality = prompt('Modifier la qualit√©:', currentQuality);
                    if (newQuality === null) return;
                    
                    const newPrice = prompt('Modifier le prix par kg (Ar):', currentPrice);
                    if (newPrice === null) return;
                    
                    const parsedWeight = parseFloat(newWeight);
                    const parsedPrice = parseFloat(newPrice.replace(/\s/g, ''));
                    
                    if (isNaN(parsedWeight) || parsedWeight < 0) {
                        alert('Poids invalide!');
                        return;
                    }
                    
                    if (isNaN(parsedPrice) || parsedPrice < 0) {
                        alert('Prix invalide!');
                        return;
                    }
                    
                    if (!newQuality.trim()) {
                        alert('La qualit√© est obligatoire!');
                        return;
                    }
                    
                    const updateTransaction = db.transaction(['weights'], 'readwrite');
                    const updateStore = updateTransaction.objectStore('weights');
                    
                    weight.weight = parsedWeight;
                    weight.date = newDate;
                    weight.note = `${newQuality.trim()}|${parsedPrice}`;
                    weight.updatedAt = new Date().toISOString();
                    
                    const updateRequest = updateStore.put(weight);
                    updateRequest.onsuccess = () => {
                        loadWeights();
                        updateStats();
                        updateSalaryStats();
                        updateEmployeeStats();
                        updateDailySummary();
                        updateDailyQualityStats();

                    };
                };
            };
        };

        // Supprimer un poids
        const deleteWeight = (id) => {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce pesage?')) return;
            
            const transaction = db.transaction(['weights'], 'readwrite');
            const store = transaction.objectStore('weights');
            
            const request = store.delete(id);
            request.onsuccess = () => {
                loadWeights();
                updateStats();
                updateSalaryStats();
                updateEmployeeStats();
                loadEmployeeManagement();
                updateDailySummary();
                updateDailyQualityStats();

            };
        };

        // Mettre √† jour les statistiques
        const updateStats = () => {
            const transaction = db.transaction(['weights', 'employees'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const employeeStore = transaction.objectStore('employees');
            
            const weightRequest = weightStore.getAll();
            const employeeRequest = employeeStore.getAll();
            
            Promise.all([
                new Promise(resolve => { weightRequest.onsuccess = () => resolve(weightRequest.result); }),
                new Promise(resolve => { employeeRequest.onsuccess = () => resolve(employeeRequest.result); })
            ]).then(([weights, employees]) => {
                const today = new Date().toISOString().split('T')[0];
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                const todayWeights = weights.filter(w => w.date === today);
                const todayTotal = todayWeights.reduce((sum, w) => sum + w.weight, 0);
                
                const monthlyWeights = weights.filter(w => {
                    const weightDate = new Date(w.date);
                    return weightDate.getMonth() === currentMonth && weightDate.getFullYear() === currentYear;
                });
                
                const monthlyTotal = monthlyWeights.reduce((sum, w) => sum + w.weight, 0);
                
                // Calculer le total g√©n√©ral de tous les poids
                const overallTotal = weights.reduce((sum, w) => sum + w.weight, 0);
                
                document.getElementById('totalEmployees').textContent = employees.length;
                document.getElementById('totalWeights').textContent = weights.length;
                document.getElementById('todayWeights').textContent = todayTotal.toFixed(1) + ' kg';
                document.getElementById('monthlyTotal').textContent = monthlyTotal.toFixed(1) + ' kg';
                document.getElementById('overallTotal').textContent = overallTotal.toFixed(1) + ' kg';
                updateSalaryStats();
                applyThousandSeparators();
                
            });
        };

        // Mettre √† jour les statistiques des salaires
        const updateSalaryStats = () => {
            const transaction = db.transaction(['weights'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const request = weightStore.getAll();
            
            request.onsuccess = () => {
                const weights = request.result;
                const today = new Date().toISOString().split('T')[0];
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                // Calculer les salaires avec prix par qualit√©
                const todayWeights = weights.filter(w => w.date === today);
                const todaySalary = todayWeights.reduce((sum, w) => sum + (w.weight * getPriceForWeight(w)), 0);
                
                const monthlyWeights = weights.filter(w => {
                    const weightDate = new Date(w.date);
                    return weightDate.getMonth() === currentMonth && weightDate.getFullYear() === currentYear;
                });
                const monthlySalary = monthlyWeights.reduce((sum, w) => sum + (w.weight * getPriceForWeight(w)), 0);
                
                const totalSalary = weights.reduce((sum, w) => sum + (w.weight * getPriceForWeight(w)), 0);
                
                // Mettre √† jour l'affichage
                document.getElementById('todaySalary').textContent = todaySalary.toLocaleString('fr-FR') + ' Ar';
                document.getElementById('monthlySalary').textContent = monthlySalary.toLocaleString('fr-FR') + ' Ar';
                document.getElementById('totalSalary').textContent = totalSalary.toLocaleString('fr-FR') + ' Ar';
                
                // Mettre √† jour le tableau des salaires par employ√©
                updateSalaryTable();
                updateSalaryByQuality(); // ‚≠ê NOUVEAU
                applyThousandSeparators();
            };
        };

        // ‚≠ê NOUVEAU: Mettre √† jour r√©partition salaires par qualit√©
        const updateSalaryByQuality = () => {
            const transaction = db.transaction(['weights', 'payments'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const paymentStore = transaction.objectStore('payments');
            
            const weightRequest = weightStore.getAll();
            const paymentRequest = paymentStore.getAll();
            
            Promise.all([
                new Promise(resolve => { weightRequest.onsuccess = () => resolve(weightRequest.result); }),
                new Promise(resolve => { paymentRequest.onsuccess = () => resolve(paymentRequest.result); })
            ]).then(([weights, payments]) => {
                const qualityMap = {};
                
                // Grouper par qualit√©
                weights.forEach(w => {
                    const qualityName = getQualityName(w);
                    const price = getPriceForWeight(w);
                    const salary = w.weight * price;
                    
                    if (!qualityMap[qualityName]) {
                        qualityMap[qualityName] = {
                            totalWeight: 0,
                            totalSalary: 0,
                            count: 0,
                            price: price
                        };
                    }
                    
                    qualityMap[qualityName].totalWeight += w.weight;
                    qualityMap[qualityName].totalSalary += salary;
                    qualityMap[qualityName].count += 1;
                });
                
                // ‚≠ê NOUVEAU: Calculer total des paiements
                const totalPayments = payments.reduce((sum, p) => sum + p.amount, 0);
                const totalSalary = Object.values(qualityMap).reduce((sum, q) => sum + q.totalSalary, 0);
                const netSalary = totalSalary - totalPayments;
                
                // G√©n√©rer les cartes
                const container = document.getElementById('salaryByQualityGrid');
                container.innerHTML = '';
                
                // Trier par salaire d√©croissant
                const sortedQualities = Object.entries(qualityMap)
                    .sort((a, b) => b[1].totalSalary - a[1].totalSalary);
                
                sortedQualities.forEach(([qualityName, data]) => {
                    // Ic√¥ne et couleurs dynamiques selon prix
                    let icon = 'üíé';
                    let gradient = 'linear-gradient(135deg, rgba(5, 150, 105, 0.15), rgba(4, 120, 87, 0.15))';
                    let textColor = '#059669';
                    let borderColor = 'rgba(5, 150, 105, 0.3)';
                    
                    if (data.price >= 500) {
                        icon = '‚≠ê';
                        gradient = 'linear-gradient(135deg, rgba(217, 119, 6, 0.15), rgba(180, 83, 9, 0.15))';
                        textColor = '#d97706';
                        borderColor = 'rgba(217, 119, 6, 0.3)';
                    } else if (data.price >= 400) {
                        icon = 'üíé';
                        gradient = 'linear-gradient(135deg, rgba(5, 150, 105, 0.15), rgba(4, 120, 87, 0.15))';
                        textColor = '#059669';
                        borderColor = 'rgba(5, 150, 105, 0.3)';
                    } else if (data.price >= 300) {
                        icon = '‚úì';
                        gradient = 'linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.15))';
                        textColor = '#3b82f6';
                        borderColor = 'rgba(59, 130, 246, 0.3)';
                    } else if (data.price > 0) {
                        icon = '‚óã';
                        gradient = 'linear-gradient(135deg, rgba(100, 116, 139, 0.15), rgba(71, 85, 105, 0.15))';
                        textColor = '#64748b';
                        borderColor = 'rgba(100, 116, 139, 0.3)';
                    }
                    
                    const avgWeight = data.totalWeight / data.count;
                    const percentTotal = sortedQualities.length > 0 ? 
                        (data.totalSalary / sortedQualities.reduce((sum, [_, d]) => sum + d.totalSalary, 0) * 100) : 0;
                    
                    const card = document.createElement('div');
                    card.style.cssText = `
                        background: ${gradient};
                        padding: 20px;
                        border-radius: 16px;
                        border: 2px solid ${borderColor};
                        transition: all 0.3s ease;
                        cursor: pointer;
                    `;
                    
                    card.onmouseover = () => {
                        card.style.transform = 'translateY(-4px)';
                        card.style.boxShadow = '0 10px 30px rgba(0,0,0,0.15)';
                    };
                    card.onmouseout = () => {
                        card.style.transform = 'translateY(0)';
                        card.style.boxShadow = 'none';
                    };
                    
                    card.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <span style="font-size: 1.5rem;">${icon}</span>
                            <span style="background: white; padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: 700; color: ${textColor};">
                                ${percentTotal.toFixed(1)}%
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <div style="font-weight: 700; color: #1e293b; font-size: 1.1rem; margin-bottom: 4px;">
                                ${qualityName}
                            </div>
                            <div style="font-size: 0.85rem; color: #64748b; font-weight: 500;">
                                ${data.price.toLocaleString('fr-FR')} Ar/kg
                            </div>
                        </div>
                        
                        <div style="height: 1px; background: ${borderColor}; margin: 12px 0;"></div>
                        
                        <div style="display: grid; gap: 8px;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                <span style="color: #64748b;">Poids:</span>
                                <span style="font-weight: 700; color: #1e293b;">${data.totalWeight.toFixed(1)} kg</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                <span style="color: #64748b;">Pesages:</span>
                                <span style="font-weight: 700; color: #1e293b;">${data.count}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                <span style="color: #64748b;">Moyenne:</span>
                                <span style="font-weight: 700; color: #1e293b;">${avgWeight.toFixed(1)} kg</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 10px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: #64748b; font-weight: 600; margin-bottom: 4px;">
                                    SALAIRE TOTAL
                                </div>
                                <div style="font-size: 1.5rem; font-weight: 800; color: ${textColor};">
                                    ${data.totalSalary.toLocaleString('fr-FR')} Ar
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
                
                // ‚≠ê NOUVEAU: Carte r√©capitulative FINALE
                const summaryCard = document.createElement('div');
                summaryCard.style.cssText = `
                    background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
                    padding: 24px;
                    border-radius: 16px;
                    border: 2px solid rgba(255, 255, 255, 0.1);
                    color: white;
                    grid-column: 1 / -1;
                `;
                
                summaryCard.innerHTML = `
                    <h4 style="color: white; margin-bottom: 16px; font-size: 1.1rem; font-weight: 700; text-align: center;">
                        üìä R√âCAPITULATIF GLOBAL
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div style="background: rgba(255,255,255,0.1); padding: 16px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 6px;">üí∞ Salaires Bruts</div>
                            <div style="font-size: 1.8rem; font-weight: 800;">${totalSalary.toLocaleString('fr-FR')} Ar</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 16px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 6px;">‚úÖ Avances Pay√©es</div>
                            <div style="font-size: 1.8rem; font-weight: 800; color: #60a5fa;">${totalPayments.toLocaleString('fr-FR')} Ar</div>
                        </div>
                        <div style="background: ${netSalary >= 0 ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; padding: 16px; border-radius: 12px; text-align: center; border: 2px solid ${netSalary >= 0 ? 'rgba(34, 197, 94, 0.4)' : 'rgba(239, 68, 68, 0.4)'};">
                            <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 6px; font-weight: 700;">‚ö†Ô∏è RESTE √Ä PAYER</div>
                            <div style="font-size: 2rem; font-weight: 900; color: ${netSalary >= 0 ? '#22c55e' : '#ef4444'};">${netSalary.toLocaleString('fr-FR')} Ar</div>
                        </div>
                    </div>
                `;
                
                container.appendChild(summaryCard);
                
                // Message si aucune donn√©e
                if (sortedQualities.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #94a3b8;">
                            <div style="font-size: 3rem; margin-bottom: 12px;">üìä</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">Aucune donn√©e disponible</div>
                            <div style="font-size: 0.9rem; margin-top: 8px;">Enregistrez des pesages pour voir les statistiques</div>
                        </div>
                    `;
                }
                
                applyThousandSeparators();
            });
        };

        // Mettre √† jour les statistiques par employ√© (avec paiements)
        const updateEmployeeStats = () => {
            const transaction = db.transaction(['weights', 'employees', 'payments'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const employeeStore = transaction.objectStore('employees');
            const paymentStore = transaction.objectStore('payments');

            const weightRequest = weightStore.getAll();
            const employeeRequest = employeeStore.getAll();
            const paymentRequest = paymentStore.getAll();

            Promise.all([
                new Promise(resolve => { weightRequest.onsuccess = () => resolve(weightRequest.result); }),
                new Promise(resolve => { employeeRequest.onsuccess = () => resolve(employeeRequest.result); }),
                new Promise(resolve => { paymentRequest.onsuccess = () => resolve(paymentRequest.result); })
            ]).then(([weights, employees, payments]) => {
                const statsContainer = document.getElementById('employeeStats');
                statsContainer.innerHTML = '';

                employees.forEach(employee => {
                    // --- Poids et salaire ---
                    const employeeWeights = weights.filter(w => w.employeeId === employee.id);
                    const totalWeight = employeeWeights.reduce((sum, w) => sum + w.weight, 0);
                    const avgWeight = employeeWeights.length > 0 ? totalWeight / employeeWeights.length : 0;
                    
                    // Calculer salaire avec prix par qualit√©
                    const salary = employeeWeights.reduce((sum, w) => sum + (w.weight * getPriceForWeight(w)), 0);

                    // --- Paiements ---
                    const employeePayments = payments.filter(p => p.employeeId === employee.id);
                    const totalPaid = employeePayments.reduce((sum, p) => sum + p.amount, 0);
                    const reste = salary - totalPaid;

                    // --- Cr√©ation de la carte am√©lior√©e ---
                    const statCard = document.createElement('div');
                    statCard.className = 'employee-stat-card';

                    let paymentsHTML = '';
                    if (employeePayments.length > 0) {
                        paymentsHTML = `
                            <div class="payment-history">
                                <h4 style="font-size: 0.9rem; color: #64748b; margin-bottom: 12px; font-weight: 600;">üìã Historique des Paiements</h4>
                                ${employeePayments.map(p => `
                                    <div class="payment-item">
                                        <div>
                                            <div style="font-weight: 600; color: #1e293b;">${p.amount.toLocaleString('fr-FR')} Ar</div>
                                            <div style="font-size: 0.8rem; color: #64748b;">${new Date(p.date).toLocaleDateString('fr-FR')}${p.note ? ' ‚Ä¢ ' + p.note : ''}</div>
                                        </div>
                                        <div class="payment-actions">
                                            <button class="payment-action-btn payment-edit-btn" onclick="editPayment(${p.id})">‚úèÔ∏è</button>
                                            <button class="payment-action-btn payment-delete-btn" onclick="deletePayment(${p.id})">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    statCard.innerHTML = `
                        <div class="employee-name-header">
                            üë§ ${employee.name}
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <div class="stat-item" style="cursor: pointer; transition: all 0.2s ease;" 
                                 onmouseover="this.style.background='rgba(5, 150, 105, 0.05)'" 
                                 onmouseout="this.style.background='transparent'"
                                 onclick="openEmployeeWeightsModal(${employee.id}, '${employee.name}')">
                                <span class="stat-label">‚öñÔ∏è Poids Total</span>
                                <span class="stat-value" style="color: #059669; display: flex; align-items: center; gap: 8px;">
                                    ${totalWeight.toFixed(1)} kg
                                    <span style="font-size: 0.75rem; opacity: 0.7;">üîç Voir d√©tail</span>
                                </span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">üìä Nombre de Pesages</span>
                                <span class="stat-value">${employeeWeights.length}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">üìà Moyenne par Pesage</span>
                                <span class="stat-value">${avgWeight.toFixed(1)} kg</span>
                            </div>
                        </div>

                        ${paymentsHTML}

                        <div class="salary-summary">
                            <div class="salary-row">
                                <span style="color: var(--text-primary);">üí∞ Salaire Total</span>
                                <span class="salary-total">${salary.toLocaleString('fr-FR')} Ar</span>
                            </div>
                            <div class="salary-row">
                                <span style="color: var(--text-primary);">‚úÖ D√©j√† Pay√©</span>
                                <span class="salary-paid">${totalPaid.toLocaleString('fr-FR')} Ar</span>
                            </div>
                            <div class="salary-row" style="border-top: 2px solid rgba(220, 38, 38, 0.2); padding-top: 8px; margin-top: 8px;">
                                <span style="color: var(--text-primary);">‚ö†Ô∏è Reste √† Payer</span>
                                <span class="salary-remaining">${reste.toLocaleString('fr-FR')} Ar</span>
                            </div>
                        </div>

                        <button onclick="openPaymentModal(${employee.id}, '${employee.name}', ${reste}, ${salary}, ${totalPaid})"
                                class="btn success" style="width: 100%; margin-top: 12px;">
                            üí∏ Effectuer un Paiement
                        </button>
                    `;
                    statsContainer.appendChild(statCard);
                });
                
            });
        };


        // Recherche intelligente am√©lior√©e dans les statistiques
        const filterEmployeeStats = () => {
            const search = document.getElementById('employeeStatsSearch').value
                .toLowerCase()
                .normalize('NFD') // retire les accents
                .replace(/[\u0300-\u036f]/g, '')
                .trim();

            const statsContainer = document.getElementById('employeeStats');
            const cards = statsContainer.querySelectorAll('.employee-stat-card');

            let visibleCount = 0;

            cards.forEach(card => {
                const text = card.innerText.toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '');
                if (text.includes(search)) {
                    card.style.display = '';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Gestion du message "Aucun r√©sultat"
            let msg = document.getElementById('noResultsMsg');
            if (visibleCount === 0 && cards.length > 0) {
                if (!msg) {
                    msg = document.createElement('div');
                    msg.id = 'noResultsMsg';
                    msg.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #94a3b8;">
                            <div style="font-size: 3rem; margin-bottom: 16px;">üîç</div>
                            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 8px;">Aucun employ√© trouv√©</div>
                            <div style="font-size: 0.95rem;">Essayez avec un autre nom ou v√©rifiez l'orthographe</div>
                        </div>
                    `;
                    statsContainer.appendChild(msg);
                }
            } else if (msg) {
                msg.remove();
            }
        };



        // Mettre √† jour le tableau des salaires par employ√©
        const updateSalaryTable = () => {
            const transaction = db.transaction(['weights', 'employees'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const employeeStore = transaction.objectStore('employees');
            
            const weightRequest = weightStore.getAll();
            const employeeRequest = employeeStore.getAll();
            
            Promise.all([
                new Promise(resolve => { weightRequest.onsuccess = () => resolve(weightRequest.result); }),
                new Promise(resolve => { employeeRequest.onsuccess = () => resolve(employeeRequest.result); })
            ]).then(([weights, employees]) => {
                const tbody = document.getElementById('salaryTableBody');
                tbody.innerHTML = '';
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                employees.forEach(employee => {
                    const employeeWeights = weights.filter(w => w.employeeId === employee.id);
                    const totalWeight = employeeWeights.reduce((sum, w) => sum + w.weight, 0);
                    
                    // Calculer salaire total avec prix par qualit√©
                    const totalSalary = employeeWeights.reduce((sum, w) => sum + (w.weight * getPriceForWeight(w)), 0);
                    
                    // Calculer le salaire du mois
                    const monthlyWeights = employeeWeights.filter(w => {
                        const weightDate = new Date(w.date);
                        return weightDate.getMonth() === currentMonth && weightDate.getFullYear() === currentYear;
                    });
                    const monthlyWeight = monthlyWeights.reduce((sum, w) => sum + w.weight, 0);
                    
                    // Calculer salaire du mois avec prix par qualit√©
                    const monthlySalary = monthlyWeights.reduce((sum, w) => sum + (w.weight * getPriceForWeight(w)), 0);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-weight: 600;">${employee.name}</td>
                        <td>${totalWeight.toFixed(1)} kg</td>
                        <td>${employeeWeights.length}</td>
                        <td style="color: #059669; font-weight: 700; font-size: 1.05rem;">${totalSalary.toLocaleString('fr-FR')} Ar</td>
                        <td style="color: #3b82f6; font-weight: 700; font-size: 1.05rem;">${monthlySalary.toLocaleString('fr-FR')} Ar</td>
                    `;
                    tbody.appendChild(row);
                });
            });
            applyThousandSeparators();
        };

        // NOUVEAU: Mettre √† jour le r√©sum√© quotidien avec calcul correct
        const updateDailySummary = () => {
            const selectedDate = document.getElementById('dateFilter').value;
            const summaryDiv = document.getElementById('dailySummary');
            
            if (!selectedDate) {
                summaryDiv.style.display = 'none';
                return;
            }
            
            const transaction = db.transaction(['weights', 'employees'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const employeeStore = transaction.objectStore('employees');
            
            const weightRequest = weightStore.getAll();
            
            weightRequest.onsuccess = () => {
                const weights = request.result;
                const dailyWeights = weights.filter(w => w.date === selectedDate);
                
                const totalWeight = dailyWeights.reduce((sum, w) => sum + w.weight, 0);
                const count = dailyWeights.length;
                
                document.getElementById('dailyTotal').textContent = totalWeight.toFixed(1) + ' kg';
                document.getElementById('dailyCount').textContent = count;
                
                summaryDiv.style.display = count > 0 ? 'block' : 'none';
            };
            applyThousandSeparators();
        };

        

        // Filtrer par mois
        // Filtrer par mois - VERSION MODIFI√âE
        const filterByMonth = () => {
            const month = document.getElementById('monthFilter').value;
            if (!month) {
                loadWeights();
                // NOUVEAU: Masquer les statistiques si pas de filtre
                document.getElementById('searchStats').style.display = 'none';
                return;
            }
            
            // R√©initialiser le filtre de date
            document.getElementById('dateFilter').value = '';
            document.getElementById('dailySummary').style.display = 'none';
            
            const transaction = db.transaction(['weights', 'employees'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const employeeStore = transaction.objectStore('employees');
            
            const request = weightStore.getAll();
            
            request.onsuccess = () => {
                const weights = request.result;
                const filteredWeights = weights.filter(w => {
                    const date = new Date(w.date);
                    return (date.getMonth() + 1).toString().padStart(2, '0') === month;
                });
                
                const employeeRequests = [];
                filteredWeights.forEach(weight => {
                    const empRequest = employeeStore.get(weight.employeeId);
                    employeeRequests.push(new Promise((resolve) => {
                        empRequest.onsuccess = () => {
                            weight.employeeName = empRequest.result ? empRequest.result.name : 'Inconnu';
                            resolve();
                        };
                    }));
                });
                
                Promise.all(employeeRequests).then(() => {
                    displayWeights(filteredWeights.reverse());
                    // NOUVEAU: Mettre √† jour les statistiques de recherche
                    updateSearchStats(filteredWeights);
                });
            };
        };

        // CORRECTION: Filtrer par date sp√©cifique avec calcul correct du total
        // CORRECTION: Filtrer par date sp√©cifique - VERSION MODIFI√âE
        const filterByDate = () => {
            const selectedDate = document.getElementById('dateFilter').value;
            if (!selectedDate) {
                loadWeights();
                document.getElementById('dailySummary').style.display = 'none';
                // NOUVEAU: Masquer les statistiques si pas de filtre
                document.getElementById('searchStats').style.display = 'none';
                return;
            }
            
            // R√©initialiser le filtre de mois
            document.getElementById('monthFilter').value = '';
            
            const transaction = db.transaction(['weights', 'employees'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const employeeStore = transaction.objectStore('employees');
            
            const request = weightStore.getAll();
            
            request.onsuccess = () => {
                const weights = request.result;
                const filteredWeights = weights.filter(w => w.date === selectedDate);
                
                // CORRECTION: Calculer le total correct pour la date s√©lectionn√©e
                const totalWeight = filteredWeights.reduce((sum, w) => sum + w.weight, 0);
                const count = filteredWeights.length;
                
                // Mettre √† jour le r√©sum√© quotidien
                document.getElementById('dailyTotal').textContent = totalWeight.toFixed(1) + ' kg';
                document.getElementById('dailyCount').textContent = count;
                document.getElementById('dailySummary').style.display = count > 0 ? 'block' : 'none';
                
                const employeeRequests = [];
                filteredWeights.forEach(weight => {
                    const empRequest = employeeStore.get(weight.employeeId);
                    employeeRequests.push(new Promise((resolve) => {
                        empRequest.onsuccess = () => {
                            weight.employeeName = empRequest.result ? empRequest.result.name : 'Inconnu';
                            resolve();
                        };
                    }));
                });
                
                Promise.all(employeeRequests).then(() => {
                    displayWeights(filteredWeights.reverse());
                    // NOUVEAU: Mettre √† jour les statistiques de recherche
                    updateSearchStats(filteredWeights);
                });
            };
        };

        // Effacer tous les filtres
        // Effacer tous les filtres - VERSION MISE √Ä JOUR
        const clearFilters = () => {
            document.getElementById('nameFilter').value = '';
            document.getElementById('selectedFilterEmployeeId').value = '';
            document.getElementById('filterEmployeeDropdown').style.display = 'none';
            document.getElementById('monthFilter').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('dailySummary').style.display = 'none';
            document.getElementById('searchStats').style.display = 'none';
            selectedFilterEmployeeIndex = -1;
            loadWeights();
        };

        // Afficher un message
        const showMessage = (elementId, message) => {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        };

        // Exporter les donn√©es CSV
        const exportData = () => {
            const transaction = db.transaction(['weights', 'employees'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const employeeStore = transaction.objectStore('employees');
            
            const weightRequest = weightStore.getAll();
            const employeeRequest = employeeStore.getAll();
            
            Promise.all([
                new Promise(resolve => { weightRequest.onsuccess = () => resolve(weightRequest.result); }),
                new Promise(resolve => { employeeRequest.onsuccess = () => resolve(employeeRequest.result); })
            ]).then(([weights, employees]) => {
                const employeeMap = {};
                employees.forEach(emp => {
                    employeeMap[emp.id] = emp.name;
                });
                
                const csvContent = "data:text/csv;charset=utf-8,"
                    + "Nom,Poids(kg),Date,Qualit√©,Prix par kg (Ar),Salaire (Ar)\n"
                    + weights.map(w => {
                        const quality = getQualityName(w);
                        const price = getPriceForWeight(w);
                        const salary = w.weight * price;
                        return `${employeeMap[w.employeeId] || 'Inconnu'},${w.weight},${w.date},"${quality}",${price},${salary}`;
                    }).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `pesage_vanille_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        };

        // Exporter les donn√©es JSON
        // Exporter les donn√©es JSON (version corrig√©e: inclut payments)
        const exportJSON = () => {
            const transaction = db.transaction(['weights', 'employees', 'prices', 'payments'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const employeeStore = transaction.objectStore('employees');
            const priceStore = transaction.objectStore('prices');
            const paymentStore = transaction.objectStore('payments');

            const weightRequest = weightStore.getAll();
            const employeeRequest = employeeStore.getAll();
            const priceRequest = priceStore.getAll();
            const paymentRequest = paymentStore.getAll();

            Promise.all([
                new Promise(resolve => { weightRequest.onsuccess = () => resolve(weightRequest.result); }),
                new Promise(resolve => { employeeRequest.onsuccess = () => resolve(employeeRequest.result); }),
                new Promise(resolve => { priceRequest.onsuccess = () => resolve(priceRequest.result); }),
                new Promise(resolve => { paymentRequest.onsuccess = () => resolve(paymentRequest.result); })
            ]).then(([weights, employees, prices, payments]) => {
                const exportData = {
                    employees: employees,
                    weights: weights,
                    prices: prices,
                    payments: payments,
                    exportDate: new Date().toISOString(),
                    version: "2.0"
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});

                const link = document.createElement("a");
                link.href = URL.createObjectURL(dataBlob);
                link.download = `pesage_vanille_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage('importSuccessMsg', 'Donn√©es export√©es avec succ√®s!');
            }).catch(err => {
                showMessage('importErrorMsg', 'Erreur lors de l\'exportation: ' + (err && err.message));
            });
        };


        // Importer les donn√©es JSON
        const importJSON = () => {
            const fileInput = document.getElementById('jsonFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('importErrorMsg', 'Veuillez s√©lectionner un fichier JSON!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.employees || !importData.weights) {
                        throw new Error('Format de fichier invalide');
                    }
                    
                    // Confirmer l'importation
                    if (!confirm('Cette action va remplacer toutes les donn√©es existantes. Continuer?')) {
                        return;
                    }
                    
                    const transaction = db.transaction(['weights', 'employees', 'prices', 'payments'], 'readwrite');
                    const weightStore = transaction.objectStore('weights');
                    const employeeStore = transaction.objectStore('employees');
                    const priceStore = transaction.objectStore('prices');
                    const paymentStore = transaction.objectStore('payments');

                    // Vider les tables existantes
                    weightStore.clear();
                    employeeStore.clear();
                    priceStore.clear();
                    paymentStore.clear();

                    // Importer les employ√©s
                    importData.employees.forEach(employee => {
                        employeeStore.add(employee);
                    });

                    // Importer les poids
                    importData.weights.forEach(weight => {
                        weightStore.add(weight);
                    });

                    // Importer les prix si disponibles
                    if (importData.prices) {
                        importData.prices.forEach(price => {
                            priceStore.add(price);
                        });
                    }

                    // Importer les paiements si disponibles
                    if (importData.payments) {
                        importData.payments.forEach(payment => {
                            paymentStore.add(payment);
                        });
                    }

                    
                    transaction.oncomplete = () => {
                        // √¢¬≠ Utiliser la fonction de rafraichissement compl√®te
                        refreshAllViews();
                        showMessage('importSuccessMsg', 'Donn√©es import√©es avec succ√©¬®s!');
                        fileInput.value = '';
                    };
                    
                    transaction.onerror = () => {
                        showMessage('importErrorMsg', 'Erreur lors de l\'importation!');
                    };
                    
                } catch (error) {
                    showMessage('importErrorMsg', 'Fichier JSON invalide!');
                }
            };
            
            reader.readAsText(file);
        };

        // Remise √† z√©ro compl√®te
        const resetAllData = () => {
            if (!confirm('√ätes-vous s√ªr de vouloir effectuer une remise √† z√©ro compl√®te? Cette action supprimera TOUTES les donn√©es de fa√ßon permanente!')) return;
            
            if (!confirm('DERNI√àRE CONFIRMATION: Toutes les donn√©es seront perdues d√©finitivement. Continuer?')) return;
            
            const transaction = db.transaction(['weights', 'employees', 'prices', 'payments'], 'readwrite');
            const weightStore = transaction.objectStore('weights');
            const employeeStore = transaction.objectStore('employees');
            const priceStore = transaction.objectStore('prices');
            const paymentStore = transaction.objectStore('payments');

            weightStore.clear();
            employeeStore.clear();
            priceStore.clear();
            paymentStore.clear();

            
            transaction.oncomplete = () => {
                // ‚≠ê OBLIGATOIRE: Miandry kely alohan'ny refresh
                setTimeout(() => {
                    // R√©initialiser prix par d√©faut
                    currentPricePerKg = 0;
                    document.getElementById('currentDefaultPrice').textContent = '0 Ar';
                    document.getElementById('defaultPricePerKg').value = '';
                    
                    // R√©initialiser formulaire pesage
                    document.getElementById('weight').value = '';
                    document.getElementById('weighingDate').value = new Date().toISOString().split('T')[0];
                    document.getElementById('qualityName').value = '';
                    document.getElementById('qualityPrice').value = '';
                    document.getElementById('employeeSearchInput').value = '';
                    document.getElementById('selectedEmployeeId').value = '';
                    
                    // R√©initialiser stats quotidiennes
                    document.getElementById('dailyStatsDate').value = new Date().toISOString().split('T')[0];
                    document.getElementById('dailyQualityStatsContainer').style.display = 'none';
                    document.getElementById('noDailyData').style.display = 'none';
                    
                    // Effacer filtre employ√© stats quotidiennes
                    dailyStatsSelectedEmployee = null;
                    document.getElementById('dailyStatsEmployeeSearch').value = '';
                    document.getElementById('selectedEmployeeInfo').style.display = 'none';
                    
                    // R√©initialiser recherche employ√©
                    document.getElementById('employeeSearchInput').value = '';
                    document.getElementById('selectedEmployeeId').value = '';
                    document.getElementById('employeeDropdown').style.display = 'none';
                    
                    // R√©initialiser filtres recherche
                    document.getElementById('nameFilter').value = '';
                    document.getElementById('selectedFilterEmployeeId').value = '';
                    document.getElementById('monthFilter').value = '';
                    document.getElementById('dateFilter').value = '';
                    document.getElementById('dailySummary').style.display = 'none';
                    document.getElementById('searchStats').style.display = 'none';
                    document.getElementById('filterEmployeeDropdown').style.display = 'none';
                    
                    // ‚≠ê RELOAD TOUS LES DONN√âES
                    loadAllEmployees();
                    loadWeights();
                    updateStats();
                    updateSalaryStats();
                    updateEmployeeStats();
                    loadEmployeeManagement();
                    
                    alert('‚úÖ Remise √† z√©ro effectu√©e avec succ√®s!\n\nToutes les donn√©es ont √©t√© supprim√©es.');
                    console.log('‚úÖ Reset termin√© et interface mise √† jour');
                }, 100);
            };
            
            transaction.onerror = () => {
                alert('‚ùå Erreur lors de la remise √† z√©ro!');
            };
        };

        // Effacer toutes les donn√©es (fonction existante conserv√©e pour compatibilit√©)
        const clearAllData = () => {
            resetAllData();
        };

        // Fermer le modal en cliquant √† l'ext√©rieur
        window.onclick = (event) => {
            const editModal = document.getElementById('editEmployeeModal');
            const weightsModal = document.getElementById('employeeWeightsModal');
            const paymentModal = document.getElementById('paymentModal');
            const editPaymentModal = document.getElementById('editPaymentModal');
            
            if (event.target === editModal) {
                closeEditEmployeeModal();
            }
            if (event.target === weightsModal) {
                closeEmployeeWeightsModal();
            }
            if (event.target === paymentModal) {
                closePaymentModal();
            }
            if (event.target === editPaymentModal) {
                closeEditPaymentModal();
            }
        };

        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', () => {
            // D√©finir la date d'aujourd'hui
            document.getElementById('weighingDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('dailyStatsDate').value = new Date().toISOString().split('T')[0];
            
            // Initialiser la base de donn√©es
            initDB();

            // D√âFINIR D'ABORD TOUTES LES FONCTIONS INTERNES
            
            // Fonction pour la navigation clavier dans le filtrage
            const handleFilterEmployeeKeyNavigation = (event) => {
                const dropdown = document.getElementById('filterEmployeeDropdown');
                const options = dropdown.querySelectorAll('.employee-option:not(.no-results)');
                
                if (options.length === 0) return;
                
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    selectedFilterEmployeeIndex = (selectedFilterEmployeeIndex + 1) % options.length;
                    updateFilterSelectedOption(options);
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    selectedFilterEmployeeIndex = selectedFilterEmployeeIndex <= 0 ? options.length - 1 : selectedFilterEmployeeIndex - 1;
                    updateFilterSelectedOption(options);
                } else if (event.key === 'Enter' && selectedFilterEmployeeIndex >= 0) {
                    event.preventDefault();
                    const selectedOption = options[selectedFilterEmployeeIndex];
                    const employeeName = selectedOption.textContent.trim();
                    
                    if (employeeName === 'Tous les employ√©s') {
                        selectFilterEmployee('', 'Tous les employ√©s', -1);
                    } else {
                        const employeeId = allEmployees.find(emp => emp.name === employeeName)?.id;
                        if (employeeId) {
                            selectFilterEmployee(employeeId, employeeName, selectedFilterEmployeeIndex - 1);
                        }
                    }
                } else if (event.key === 'Escape') {
                    dropdown.style.display = 'none';
                    selectedFilterEmployeeIndex = -1;
                }
            };

            // Mettre √† jour l'option s√©lectionn√©e visuellement pour le filtrage
            const updateFilterSelectedOption = (options) => {
                options.forEach((option, index) => {
                    option.classList.toggle('selected', index === selectedFilterEmployeeIndex);
                });
                
                if (selectedFilterEmployeeIndex >= 0 && options[selectedFilterEmployeeIndex]) {
                    options[selectedFilterEmployeeIndex].scrollIntoView({ block: 'nearest' });
                }
            };

            // MAINTENANT AJOUTER LES EVENT LISTENERS
            
            // Event listeners de base
            document.getElementById('employeeName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addEmployee();
            });
            
            document.getElementById('weight').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addWeight();
            });

            document.getElementById('editEmployeeName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveEmployeeChanges();
            });

            // Event listeners pour la recherche d'employ√©s (Enregistrement du Pesage)
            const employeeSearchInput = document.getElementById('employeeSearchInput');
            employeeSearchInput.addEventListener('keydown', handleEmployeeKeyNavigation);
            employeeSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && selectedEmployeeIndex === -1) {
                    // Si l'utilisateur appuie sur Entr√©e sans s√©lection, enregistrer le pesage
                    if (document.getElementById('selectedEmployeeId').value) {
                        addWeight();
                    }
                }
            });

            // Event listeners pour la recherche de filtrage d'employ√©s (Recherche et Filtrage)
            const nameFilterInput = document.getElementById('nameFilter');
            nameFilterInput.addEventListener('keydown', handleFilterEmployeeKeyNavigation);

            // Gestion des clics ext√©rieurs pour fermer les dropdowns
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('employeeDropdown');
                const filterDropdown = document.getElementById('filterEmployeeDropdown');
                
                // V√©rifier pour le dropdown principal (Enregistrement du Pesage)
                const searchContainer = document.querySelector('.employee-search-container');
                if (!searchContainer || !searchContainer.contains(e.target)) {
                    dropdown.style.display = 'none';
                    selectedEmployeeIndex = -1;
                }
                
                // V√©rifier pour le dropdown de filtrage (Recherche et Filtrage)
                const filterContainers = document.querySelectorAll('.employee-search-container');
                let clickedInFilterContainer = false;
                filterContainers.forEach(container => {
                    if (container.contains(e.target)) {
                        clickedInFilterContainer = true;
                    }
                });
                
                if (!clickedInFilterContainer) {
                    filterDropdown.style.display = 'none';
                    selectedFilterEmployeeIndex = -1;
                }
            });

            // Emp√™cher la fermeture des dropdowns lors du clic sur eux
            document.getElementById('employeeDropdown').addEventListener('click', (e) => {
                e.stopPropagation();
            });

            document.getElementById('filterEmployeeDropdown').addEventListener('click', (e) => {
                e.stopPropagation();
            });
        });
        // NOUVEAU: Mettre √† jour les statistiques des r√©sultats de recherche
        const updateSearchStats = (weights) => {
            const statsDiv = document.getElementById('searchStats');
            
            if (!weights || weights.length === 0) {
                statsDiv.style.display = 'none';
                return;
            }
            
            // Calculer les statistiques
            const totalWeight = weights.reduce((sum, w) => sum + w.weight, 0);
            const averageWeight = totalWeight / weights.length;
            const count = weights.length;
            
            // Mettre √† jour l'affichage
            document.getElementById('searchTotalWeight').textContent = totalWeight.toFixed(1) + ' kg';
            document.getElementById('searchAverage').textContent = averageWeight.toFixed(1) + ' kg';
            document.getElementById('searchCount').textContent = count;
            
            // Afficher la section
            statsDiv.style.display = 'block';
            applyThousandSeparators();
        };
        // Variables pour la recherche de filtrage d'employ√©s
        let selectedFilterEmployeeIndex = -1;

        // Afficher la liste d√©roulante des employ√©s pour le filtrage
        const showFilterEmployeeDropdown = () => {
            const dropdown = document.getElementById('filterEmployeeDropdown');
            const searchInput = document.getElementById('nameFilter');
            
            if (allEmployees.length === 0) {
                dropdown.innerHTML = '<div class="employee-option no-results">Aucun employ√© trouv√©</div>';
            } else {
                // Ajouter une option "Tous les employ√©s" au d√©but
                const allOption = '<div class="employee-option" onclick="selectFilterEmployee(\'\', \'Tous les employ√©s\', -1)">Tous les employ√©s</div>';
                const employeeOptions = allEmployees.map((employee, index) => 
                    `<div class="employee-option" onclick="selectFilterEmployee(${employee.id}, '${employee.name}', ${index})" 
                        data-index="${index}">
                        ${employee.name}
                    </div>`
                ).join('');
                dropdown.innerHTML = allOption + employeeOptions;
            }
            
            dropdown.style.display = 'block';
            dropdown.style.zIndex = '9999';
        };

        // Rechercher des employ√©s pour le filtrage
        const filterEmployeeSearch = () => {
            const searchTerm = document.getElementById('nameFilter').value.toLowerCase();
            const dropdown = document.getElementById('filterEmployeeDropdown');
            selectedFilterEmployeeIndex = -1;
            
            if (searchTerm === '') {
                showFilterEmployeeDropdown();
                // Si le champ est vide, afficher tous les poids
                loadWeights();
                document.getElementById('searchStats').style.display = 'none';
                return;
            }
            
            const filteredEmployees = allEmployees.filter(employee => 
                employee.name.toLowerCase().includes(searchTerm)
            );
            
            displayFilterEmployeeOptions(filteredEmployees);
            
            dropdown.style.display = 'block';
            dropdown.style.zIndex = '9999';
            
            // Filtrer automatiquement pendant la saisie
            filterBySelectedEmployee(searchTerm);
        };

        // Afficher les options d'employ√©s pour le filtrage
        const displayFilterEmployeeOptions = (employees) => {
            const dropdown = document.getElementById('filterEmployeeDropdown');
            
            if (employees.length === 0) {
                dropdown.innerHTML = '<div class="employee-option no-results">Aucun employ√© trouv√©</div>';
            } else {
                const allOption = '<div class="employee-option" onclick="selectFilterEmployee(\'\', \'Tous les employ√©s\', -1)">Tous les employ√©s</div>';
                const employeeOptions = employees.map((employee, index) => 
                    `<div class="employee-option" onclick="selectFilterEmployee(${employee.id}, '${employee.name}', ${index})" 
                        data-index="${index}">
                        ${employee.name}
                    </div>`
                ).join('');
                dropdown.innerHTML = allOption + employeeOptions;
            }
        };

        // S√©lectionner un employ√© pour le filtrage
        const selectFilterEmployee = (id, name, index = -1) => {
            document.getElementById('nameFilter').value = name === 'Tous les employ√©s' ? '' : name;
            document.getElementById('selectedFilterEmployeeId').value = id;
            document.getElementById('filterEmployeeDropdown').style.display = 'none';
            selectedFilterEmployeeIndex = index;
            
            // Appliquer le filtre imm√©diatement
            if (name === 'Tous les employ√©s') {
                loadWeights();
                document.getElementById('searchStats').style.display = 'none';
            } else {
                filterBySelectedEmployee(name);
            }
        };

    

        // Filtrer par employ√© s√©lectionn√©
        const filterBySelectedEmployee = (employeeName) => {
            const transaction = db.transaction(['weights', 'employees'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const employeeStore = transaction.objectStore('employees');
            
            const request = weightStore.getAll();
            
            request.onsuccess = () => {
                const weights = request.result;
                const employeeRequests = [];
                
                weights.forEach(weight => {
                    const empRequest = employeeStore.get(weight.employeeId);
                    employeeRequests.push(new Promise((resolve) => {
                        empRequest.onsuccess = () => {
                            weight.employeeName = empRequest.result ? empRequest.result.name : 'Inconnu';
                            resolve();
                        };
                    }));
                });
                
                Promise.all(employeeRequests).then(() => {
                    const filteredWeights = weights.filter(w => 
                        w.employeeName.toLowerCase().includes(employeeName.toLowerCase())
                    );
                    displayWeights(filteredWeights.reverse());
                    updateSearchStats(filteredWeights);
                });
            };
        };

        let currentPaymentEmployee = null;
        let currentPaymentReste = 0;
        let currentEditingPaymentId = null;
        // ‚≠ê NOUVEAU: Variables pour modal d√©tail poids
        let currentModalEmployeeId = null;
        let currentModalEmployeeName = '';
        let allModalWeights = [];
        let filteredModalWeights = [];

        // ‚≠ê NOUVEAU: Ouvrir modal d√©tail poids employ√©
        const openEmployeeWeightsModal = (employeeId, employeeName) => {
            currentModalEmployeeId = employeeId;
            currentModalEmployeeName = employeeName;
            
            document.getElementById('weightsModalEmployeeName').textContent = employeeName;
            
            const transaction = db.transaction(['weights'], 'readonly');
            const store = transaction.objectStore('weights');
            const request = store.getAll();
            
            request.onsuccess = () => {
                allModalWeights = request.result.filter(w => w.employeeId === employeeId);
                
                // Trier par date d√©croissante
                allModalWeights.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Remplir le filtre qualit√©s
                const qualities = [...new Set(allModalWeights.map(w => getQualityName(w)))];
                const qualityFilter = document.getElementById('modalQualityFilter');
                qualityFilter.innerHTML = '<option value="">Toutes les qualit√©s</option>';
                qualities.forEach(q => {
                    qualityFilter.innerHTML += `<option value="${q}">${q}</option>`;
                });
                
                // Afficher tout par d√©faut
                filteredModalWeights = [...allModalWeights];
                displayModalWeights();
                updateModalStats();
                
                document.getElementById('employeeWeightsModal').style.display = 'block';
            };
        };

        // ‚≠ê NOUVEAU: Afficher les poids dans le modal
        const displayModalWeights = () => {
            const tbody = document.getElementById('employeeWeightsTableBody');
            tbody.innerHTML = '';
            
            if (filteredModalWeights.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                            üì≠ Aucun pesage trouv√©
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredModalWeights.forEach(w => {
                const qualityName = getQualityName(w);
                const price = getPriceForWeight(w);
                const salary = w.weight * price;
                
                // Ic√¥ne dynamique
                let icon = 'üíé';
                let bgColor = 'rgba(5, 150, 105, 0.1)';
                let textColor = '#059669';
                let borderColor = 'rgba(5, 150, 105, 0.2)';
                
                if (price >= 500) {
                    icon = '‚≠ê';
                    bgColor = 'rgba(217, 119, 6, 0.1)';
                    textColor = '#d97706';
                    borderColor = 'rgba(217, 119, 6, 0.2)';
                } else if (price >= 400) {
                    icon = 'üíé';
                } else if (price >= 300) {
                    icon = '‚úì';
                    bgColor = 'rgba(59, 130, 246, 0.1)';
                    textColor = '#3b82f6';
                    borderColor = 'rgba(59, 130, 246, 0.2)';
                } else if (price > 0) {
                    icon = '‚óã';
                    bgColor = 'rgba(100, 116, 139, 0.1)';
                    textColor = '#64748b';
                    borderColor = 'rgba(100, 116, 139, 0.2)';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600;">${new Date(w.date).toLocaleDateString('fr-FR')}</td>
                    <td>
                        <span class="quality-badge" style="background: ${bgColor}; color: ${textColor}; border-color: ${borderColor};">
                            ${icon} ${qualityName}
                        </span>
                    </td>
                    <td style="font-weight: 700; color: #1e293b;">${w.weight.toFixed(1)} kg</td>
                    <td style="font-weight: 600; color: ${textColor};">${price.toLocaleString('fr-FR')} Ar</td>
                    <td style="font-weight: 700; color: #047857;">${salary.toLocaleString('fr-FR')} Ar</td>
                    <td>
                        <button class="edit-btn" onclick="editWeight(${w.id})" style="padding: 6px 12px; font-size: 0.8rem;">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteWeightFromModal(${w.id})" style="padding: 6px 12px; font-size: 0.8rem;">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            applyThousandSeparators();
        };

        // ‚≠ê NOUVEAU: Mettre √† jour les stats du modal
        const updateModalStats = () => {
            const totalWeight = filteredModalWeights.reduce((sum, w) => sum + w.weight, 0);
            const totalSalary = filteredModalWeights.reduce((sum, w) => sum + (w.weight * getPriceForWeight(w)), 0);
            const avgWeight = filteredModalWeights.length > 0 ? totalWeight / filteredModalWeights.length : 0;
            
            document.getElementById('modalTotalWeight').textContent = totalWeight.toFixed(1) + ' kg';
            document.getElementById('modalTotalPesages').textContent = filteredModalWeights.length;
            document.getElementById('modalAvgWeight').textContent = avgWeight.toFixed(1) + ' kg';
            document.getElementById('modalTotalSalary').textContent = totalSalary.toLocaleString('fr-FR') + ' Ar';
        };

        // ‚≠ê NOUVEAU: Filtrer les poids dans le modal
        const filterModalWeights = () => {
            const monthFilter = document.getElementById('modalMonthFilter').value;
            const qualityFilter = document.getElementById('modalQualityFilter').value;
            
            filteredModalWeights = allModalWeights.filter(w => {
                let match = true;
                
                // Filtre mois
                if (monthFilter) {
                    const weightMonth = w.date.substring(0, 7); // YYYY-MM
                    match = match && (weightMonth === monthFilter);
                }
                
                // Filtre qualit√©
                if (qualityFilter) {
                    match = match && (getQualityName(w) === qualityFilter);
                }
                
                return match;
            });
            
            displayModalWeights();
            updateModalStats();
        };

        // ‚≠ê NOUVEAU: Effacer filtres modal
        const clearModalFilters = () => {
            document.getElementById('modalMonthFilter').value = '';
            document.getElementById('modalQualityFilter').value = '';
            filteredModalWeights = [...allModalWeights];
            displayModalWeights();
            updateModalStats();
        };

        // ‚≠ê NOUVEAU: Fermer modal
        const closeEmployeeWeightsModal = () => {
            document.getElementById('employeeWeightsModal').style.display = 'none';
            currentModalEmployeeId = null;
            currentModalEmployeeName = '';
            allModalWeights = [];
            filteredModalWeights = [];
        };

        // ‚≠ê NOUVEAU: Supprimer poids depuis modal (avec refresh)
        const deleteWeightFromModal = (id) => {
            if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer ce pesage?')) return;
            
            const transaction = db.transaction(['weights'], 'readwrite');
            const store = transaction.objectStore('weights');
            
            const request = store.delete(id);
            request.onsuccess = () => {
                // Recharger les donn√©es du modal
                openEmployeeWeightsModal(currentModalEmployeeId, currentModalEmployeeName);
                
                // Mettre √† jour les autres vues
                loadWeights();
                updateStats();
                updateSalaryStats();
                updateEmployeeStats();
                loadEmployeeManagement();
            };
        };

        // ‚≠ê NOUVEAU: Exporter CSV pour cet employ√© uniquement
        const exportEmployeeWeights = () => {
            const csvContent = "data:text/csv;charset=utf-8,"
                + "Date,Poids (kg),Qualit√©,Prix/kg (Ar),Salaire (Ar)\n"
                + filteredModalWeights.map(w => {
                    const quality = getQualityName(w);
                    const price = getPriceForWeight(w);
                    const salary = w.weight * price;
                    return `${w.date},${w.weight},"${quality}",${price},${salary}`;
                }).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `pesages_${currentModalEmployeeName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const openPaymentModal = async (id, name, reste, totalSalary, alreadyPaid) => { // ‚≠ê async
            // ‚≠ê V√âRIFIER ALERTE
            await checkEmployeeAlert(id, name);
            
            currentPaymentEmployee = id;
            currentPaymentReste = reste;

            document.getElementById('paymentEmployeeName').textContent = name;
            document.getElementById('paymentTotalSalary').textContent = totalSalary.toLocaleString('fr-FR') + ' Ar';
            document.getElementById('paymentAlreadyPaid').textContent = alreadyPaid.toLocaleString('fr-FR') + ' Ar';
            document.getElementById('paymentRemaining').textContent = reste.toLocaleString('fr-FR') + ' Ar';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentNote').value = '';
            document.getElementById('paymentModal').style.display = 'block';
            
            applyThousandSeparators();
        };

        const closePaymentModal = () => {
            document.getElementById('paymentModal').style.display = 'none';
            currentPaymentEmployee = null;
            currentPaymentReste = 0;
        };

        const confirmPayment = () => {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            const note = document.getElementById('paymentNote').value.trim();
            
            if (isNaN(amount) || amount <= 0) {
                alert("‚ö†Ô∏è Veuillez entrer un montant valide !");
                return;
            }

            if (!date) {
                alert("‚ö†Ô∏è Veuillez s√©lectionner une date !");
                return;
            }

            if (amount > currentPaymentReste) {
                if (!confirm(`‚ö†Ô∏è Le montant (${amount.toLocaleString('fr-FR')} Ar) d√©passe le reste √† payer (${currentPaymentReste.toLocaleString('fr-FR')} Ar).\n\nContinuer quand m√™me ?`)) {
                    return;
                }
            }

            const transaction = db.transaction(['payments'], 'readwrite');
            const store = transaction.objectStore('payments');
            const paymentData = {
                employeeId: currentPaymentEmployee,
                amount: amount,
                date: date,
                note: note || null,
                createdAt: new Date().toISOString()
            };
            
            store.add(paymentData);

            transaction.oncomplete = () => {
                alert("‚úÖ Paiement enregistr√© avec succ√®s !");
                closePaymentModal();
                updateEmployeeStats();
                updateSalaryStats();
            };

            transaction.onerror = () => {
                alert("‚ùå Erreur lors de l'enregistrement du paiement !");
            };
        };

        // Modifier un paiement
        const editPayment = (paymentId) => {
            const transaction = db.transaction(['payments'], 'readonly');
            const store = transaction.objectStore('payments');
            const request = store.get(paymentId);

            request.onsuccess = () => {
                const payment = request.result;
                if (!payment) return;

                currentEditingPaymentId = paymentId;
                document.getElementById('editPaymentAmount').value = payment.amount;
                document.getElementById('editPaymentDate').value = payment.date;
                document.getElementById('editPaymentNote').value = payment.note || '';
                document.getElementById('editPaymentModal').style.display = 'block';
            };
        };

        const closeEditPaymentModal = () => {
            document.getElementById('editPaymentModal').style.display = 'none';
            currentEditingPaymentId = null;
        };

        const savePaymentChanges = () => {
            const amount = parseFloat(document.getElementById('editPaymentAmount').value);
            const date = document.getElementById('editPaymentDate').value;
            const note = document.getElementById('editPaymentNote').value.trim();

            if (isNaN(amount) || amount <= 0) {
                alert("‚ö†Ô∏è Veuillez entrer un montant valide !");
                return;
            }

            if (!date) {
                alert("‚ö†Ô∏è Veuillez s√©lectionner une date !");
                return;
            }

            const transaction = db.transaction(['payments'], 'readwrite');
            const store = transaction.objectStore('payments');
            
            const request = store.get(currentEditingPaymentId);
            
            request.onsuccess = () => {
                const payment = request.result;
                if (payment) {
                    payment.amount = amount;
                    payment.date = date;
                    payment.note = note || null;
                    payment.updatedAt = new Date().toISOString();
                    
                    const updateRequest = store.put(payment);
                    
                    updateRequest.onsuccess = () => {
                        alert("‚úÖ Paiement modifi√© avec succ√®s!");
                        closeEditPaymentModal();
                        updateEmployeeStats();
                        updateSalaryStats();
                    };
                    
                    updateRequest.onerror = () => {
                        alert("‚ùå Erreur lors de la modification!");
                    };
                }
            };
            
            request.onerror = () => {
                alert("‚ùå Paiement introuvable!");
            };
        };
        
        // Supprimer un paiement
        const deletePayment = (paymentId) => {
            if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer ce paiement?')) {
                return;
            }
            
            const transaction = db.transaction(['payments'], 'readwrite');
            const store = transaction.objectStore('payments');
            const request = store.delete(paymentId);
            
            request.onsuccess = () => {
                alert("‚úÖ Paiement supprim√© avec succ√®s!");
                updateEmployeeStats();
                updateSalaryStats();
            };
            
            request.onerror = () => {
                alert("‚ùå Erreur lors de la suppression!");
            };
        };
        
        // -------------------------------
        // Helpers formatting (s√©parateur de milliers)
        // -------------------------------
        const formatNumber = (num) => {
            if (num === null || num === undefined || isNaN(num)) return num;
            // Utilise la locale fr-FR pour espaces ins√©cables comme s√©parateur de milliers
            return Number(num).toLocaleString('fr-FR');
        };

        const formatKg = (num, decimals = 1) => {
            if (num === null || num === undefined || isNaN(num)) return num;
            // garder 1 d√©cimale (ou autres si pr√©cis√©) puis formater les milliers pour la partie enti√®re
            const fixed = Number(num).toFixed(decimals); // ex: "12345.6"
            // s√©parer nombre et d√©cimales
            const parts = fixed.split('.');
            parts[0] = Number(parts[0]).toLocaleString('fr-FR');
            return parts.join('.') + ' kg';
        };

        const formatCurrency = (num) => {
            if (num === null || num === undefined || isNaN(num)) return num;
            // Retirer les d√©cimales si aucune ; toLocaleString g√®re bien
            return Number(num).toLocaleString('fr-FR') + ' Ar';
        };

        // Remplace tous les nombres trouv√©s dans une cha√Æne (ex: "12345 kg" -> "12 345 kg")
        const replaceNumbersInString = (str) => {
            if (!str || typeof str !== 'string') return str;
            // Regex pour trouver nombres (entiers ou d√©cimaux)
            return str.replace(/(\d{1,3}(?:\d{3})*(?:[.,]\d+)?|\d+(?:[.,]\d+)?)/g, (match) => {
                // nettoyer s√©parateurs √©ventuels
                const normalized = match.replace(/\s/g, '').replace(',', '.');
                if (normalized.includes('.')) {
                    // d√©cimales -> garder 1 d√©cimale si c'est un kg, sinon formater
                    return Number(normalized).toLocaleString('fr-FR');
                } else {
                    return Number(normalized).toLocaleString('fr-FR');
                }
            });
        };

        // -------------------------------
        // Fonction qui applique le formatage sur les √©l√©ments cl√©s de la page
        // -------------------------------
        const applyThousandSeparators = () => {
            try {
                // IDs simples (compteurs)
                const idMap = [
                    { id: 'totalEmployees', fn: (v) => formatNumber(Number(v)) },
                    { id: 'totalWeights', fn: (v) => formatNumber(Number(v)) },
                    { id: 'todayWeights', fn: (v) => {
                        // peut contenir "xx.x kg"
                        const n = parseFloat(String(v).replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                        return formatKg(n, 1);
                    }},
                    { id: 'monthlyTotal', fn: (v) => {
                        const n = parseFloat(String(v).replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                        return formatKg(n, 1);
                    }},
                    { id: 'overallTotal', fn: (v) => {
                        const n = parseFloat(String(v).replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                        return formatKg(n, 1);
                    }},
                    { id: 'todaySalary', fn: (v) => {
                        const n = parseFloat(String(v).replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                        return formatCurrency(n);
                    }},
                    { id: 'monthlySalary', fn: (v) => {
                        const n = parseFloat(String(v).replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                        return formatCurrency(n);
                    }},
                    { id: 'totalSalary', fn: (v) => {
                        const n = parseFloat(String(v).replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                        return formatCurrency(n);
                    }},
                    { id: 'searchTotalWeight', fn: (v) => {
                        const n = parseFloat(String(v).replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                        return formatKg(n, 1);
                    }},
                    { id: 'searchAverage', fn: (v) => {
                        const n = parseFloat(String(v).replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                        return formatKg(n, 1);
                    }},
                    { id: 'searchCount', fn: (v) => formatNumber(Number(v)) },
                    { id: 'dailyTotal', fn: (v) => {
                        const n = parseFloat(String(v).replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                        return formatKg(n, 1);
                    }},
                    { id: 'dailyCount', fn: (v) => formatNumber(Number(v)) },
                    { id: 'currentPrice', fn: (v) => {
                        const n = parseFloat(String(v).replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                        return formatCurrency(n);
                    }}
                ];

                idMap.forEach(item => {
                    const el = document.getElementById(item.id);
                    if (el && el.textContent.trim() !== '') {
                        // Extraire valeur brute puis formater
                        const raw = el.textContent.trim();
                        // Appeler fn(pass√©e) dengan raw
                        el.textContent = item.fn(raw.replace(/\s/g, ''));
                    }
                });

                // Stat-cards qui sont g√©n√©r√©s dynamiquement: format h3 (poids) sy block salaire ao anatiny
                document.querySelectorAll('.stat-card').forEach(card => {
                    // Format h3 content (souvent "1234.5 kg" or "0 kg")
                    const h3 = card.querySelector('h3');
                    if (h3) {
                        const txt = h3.textContent.trim();
                        // si misy "kg" ao anatiny, formatKg
                        if (/kg/i.test(txt)) {
                            const n = parseFloat(txt.replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                            h3.textContent = formatKg(n, 1);
                        } else {
                            // tsy misy kg -> integer counter
                            const n = parseFloat(txt.replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                            h3.textContent = formatNumber(n);
                        }
                    }

                    // Ao anatin'ny card mety misy ligne vola (Ar) ‚Äî ovaina koa
                    card.querySelectorAll('p, small, div').forEach(node => {
                        if (!node || !node.textContent) return;
                        // raha misy "Ar" ao anaty texte, format currency ao ambadika
                        if (/\bAr\b/.test(node.textContent) || /Ar\s*$/.test(node.textContent)) {
                            // extract number
                            const num = parseFloat(node.textContent.replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                            node.innerHTML = replaceNumbersInString(node.textContent).replace(/\d[\d\s.,]*\d\s*Ar/, formatCurrency(num));
                        } else {
                            // raha tsy vola nefa misy nombre, ataovy ihany koa ny formatting mitovy
                            node.textContent = replaceNumbersInString(node.textContent);
                        }
                    });
                });

                // Tableau des salaires : formater les cellules o√π il y a des montants / kg
                document.querySelectorAll('#salaryTableBody tr').forEach(tr => {
                    tr.querySelectorAll('td').forEach(td => {
                        if (!td) return;
                        td.textContent = replaceNumbersInString(td.textContent);
                    });
                });

                // Liste des poids : formater la colonne poids
                document.querySelectorAll('#weightsTableBody tr').forEach(tr => {
                    const tds = tr.querySelectorAll('td');
                    if (tds.length >= 3) {
                        // colonne poids est td[2]
                        const val = tds[2].textContent.trim();
                        const n = parseFloat(val.replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                        tds[2].textContent = formatKg(n, 1);
                    }
                    // date and other columns remain as-is
                });

            } catch (err) {
                console.warn('applyThousandSeparators error:', err);
            }
        };
        // -------------------------------
        // FIN helpers
        // -------------------------------
        // ‚≠ê BONUS: Reprendre derni√®re saisie
        const fillLastEntry = () => {
            const transaction = db.transaction(['weights'], 'readonly');
            const store = transaction.objectStore('weights');
            const request = store.getAll();
            
            request.onsuccess = () => {
                const weights = request.result;
                if (weights.length === 0) {
                    alert('Aucun pesage pr√©c√©dent trouv√©!');
                    return;
                }
                
                // Prendre le dernier pesage
                const lastWeight = weights[weights.length - 1];
                
                // Extraire qualit√© et prix
                if (lastWeight.note && lastWeight.note.includes('|')) {
                    const parts = lastWeight.note.split('|');
                    document.getElementById('qualityName').value = parts[0];
                    document.getElementById('qualityPrice').value = parseFloat(parts[1]).toLocaleString('fr-FR');
                    alert('‚úÖ Qualit√© et prix r√©cup√©r√©s!');
                } else {
                    alert('‚ö†Ô∏è Le dernier pesage n\'a pas de qualit√© d√©finie');
                }
            };
        };

        // ‚≠ê NOUVEAU: Mettre √† jour les statistiques quotidiennes par qualit√©
        // REPLACE the existing updateDailyQualityStats with this full implementation
        const updateDailyQualityStats = () => {
            const selectedDate = document.getElementById('dailyStatsDate').value;

            if (!selectedDate) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner une date!');
                return;
            }

            const transaction = db.transaction(['weights', 'employees'], 'readonly');
            const weightStore = transaction.objectStore('weights');
            const employeeStore = transaction.objectStore('employees');

            const weightRequest = weightStore.getAll();
            const employeeRequest = employeeStore.getAll();

            Promise.all([
                new Promise(resolve => { weightRequest.onsuccess = () => resolve(weightRequest.result); }),
                new Promise(resolve => { employeeRequest.onsuccess = () => resolve(employeeRequest.result); })
            ]).then(([weights, employees]) => {
                // Filtrer par date
                let dailyWeights = weights.filter(w => w.date === selectedDate);

                // ‚≠ê FILTRER PAR EMPLOY√â si s√©lectionn√©
                if (dailyStatsSelectedEmployee) {
                    dailyWeights = dailyWeights.filter(w => w.employeeId === dailyStatsSelectedEmployee.id);
                }

                if (dailyWeights.length === 0) {
                    document.getElementById('dailyQualityStatsContainer').style.display = 'none';
                    document.getElementById('noDailyData').style.display = 'block';
                    return;
                }

                document.getElementById('dailyQualityStatsContainer').style.display = 'block';
                document.getElementById('noDailyData').style.display = 'none';

                // Afficher la date s√©lectionn√©e
                // Afficher date + employ√© si filtr√©
                let dateDisplay = new Date(selectedDate).toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                if (dailyStatsSelectedEmployee) {
                    dateDisplay += ` - <strong style="color: #1e40af;">üë§ ${dailyStatsSelectedEmployee.name}</strong>`;
                }

                document.getElementById('selectedDateDisplay').innerHTML = dateDisplay;

                // ‚≠ê NOUVEAU: R√©cup√©rer limites personnalis√©es
                const minLimit = parseFloat(document.getElementById('minWeightFilter').value) || 0;
                const maxLimit = parseFloat(document.getElementById('maxWeightFilter').value) || Infinity;

                // ‚≠ê NOUVEAU: Grouper par employ√© ET par qualit√© pour total
                const employeeQualityTotals = {}; // { employeeId: { qualityName: totalWeight } }

                dailyWeights.forEach(w => {
                    if (!employeeQualityTotals[w.employeeId]) {
                        employeeQualityTotals[w.employeeId] = {
                            name: employees.find(e => e.id === w.employeeId)?.name || 'Inconnu',
                            qualities: {}
                        };
                    }
                    
                    const qualityName = getQualityName(w);
                    if (!employeeQualityTotals[w.employeeId].qualities[qualityName]) {
                        employeeQualityTotals[w.employeeId].qualities[qualityName] = {
                            totalWeight: 0,
                            count: 0
                        };
                    }
                    
                    employeeQualityTotals[w.employeeId].qualities[qualityName].totalWeight += w.weight;
                    employeeQualityTotals[w.employeeId].qualities[qualityName].count += 1;
                });

                // ‚≠ê NOUVEAU: Organiser par qualit√©
                const qualityEmployeeLists = {}; // { qualityName: { over: [], under: [], inRange: [] } }

                Object.entries(employeeQualityTotals).forEach(([empId, empData]) => {
                    Object.entries(empData.qualities).forEach(([qualityName, qualityData]) => {
                        if (!qualityEmployeeLists[qualityName]) {
                            qualityEmployeeLists[qualityName] = {
                                over: [],
                                under: [],
                                inRange: []
                            };
                        }

                        const employeeInfo = {
                            id: empId,
                            name: empData.name,
                            totalWeight: qualityData.totalWeight,
                            count: qualityData.count
                        };

                        if (maxLimit < Infinity && qualityData.totalWeight > maxLimit) {
                            qualityEmployeeLists[qualityName].over.push(employeeInfo);
                        } else if (minLimit > 0 && qualityData.totalWeight < minLimit) {
                            qualityEmployeeLists[qualityName].under.push(employeeInfo);
                        } else {
                            qualityEmployeeLists[qualityName].inRange.push(employeeInfo);
                        }
                    });
                });

                // Calculer les totaux globaux et construire la map par qualit√©
                let totalWeight = 0;
                let totalSalary = 0;
                const qualityMap = {};

                dailyWeights.forEach(w => {
                    const qualityName = getQualityName(w);
                    const price = getPriceForWeight(w);
                    const salary = w.weight * price;

                    totalWeight += w.weight;
                    totalSalary += salary;

                    if (!qualityMap[qualityName]) {
                        qualityMap[qualityName] = {
                            totalWeight: 0,
                            count: 0,
                            totalSalary: 0,
                            price: price,
                            perEmployee: {},
                            details: []
                        };
                    }

                    qualityMap[qualityName].totalWeight += w.weight;
                    qualityMap[qualityName].count += 1;
                    qualityMap[qualityName].totalSalary += salary;
                    qualityMap[qualityName].details.push({
                        employeeId: w.employeeId,
                        weight: w.weight,
                        price: price,
                        salary: salary
                    });

                    if (!qualityMap[qualityName].perEmployee[w.employeeId]) {
                        qualityMap[qualityName].perEmployee[w.employeeId] = 0;
                    }
                    qualityMap[qualityName].perEmployee[w.employeeId] += w.weight;
                });

                // Calculer global min/max
                const allWeights = dailyWeights.map(w => w.weight);
                const globalMin = Math.min(...allWeights);
                const globalMax = Math.max(...allWeights);

                // Afficher les totaux globaux
                document.getElementById('dailyTotalKg').textContent = totalWeight.toFixed(1) + ' kg';
                document.getElementById('dailyTotalSalary').textContent = totalSalary.toLocaleString('fr-FR') + ' Ar';
                document.getElementById('dailyTotalPesages').textContent = dailyWeights.length;
                document.getElementById('dailyMinWeight').textContent = globalMin.toFixed(1) + ' kg';
                document.getElementById('dailyMaxWeight').textContent = globalMax.toFixed(1) + ' kg';

                // ‚≠ê NOUVEAU: Afficher les listes PAR QUALIT√â
                const outOfRangeLists = document.getElementById('outOfRangeLists');
                const hasFilters = minLimit > 0 || maxLimit < Infinity;
                
                if (hasFilters) {
                    outOfRangeLists.style.display = 'block';
                    outOfRangeLists.innerHTML = ''; // Vider

                    Object.keys(qualityEmployeeLists).sort().forEach(qualityName => {
                        const lists = qualityEmployeeLists[qualityName];
                        const hasData = lists.over.length > 0 || lists.under.length > 0 || lists.inRange.length > 0;
                        
                        if (!hasData) return;

                        // Container pour cette qualit√©
                        const qualitySection = document.createElement('div');
                        qualitySection.style.cssText = 'margin-bottom: 30px; padding: 20px; background: rgba(255,255,255,0.95); border-radius: 16px; border: 2px solid rgba(100,116,139,0.2);';

                        let qualityHTML = `
                            <h3 style="color: #1e293b; margin-bottom: 16px; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                                üíé ${qualityName}
                            </h3>
                        `;

                        // Liste SUP√âRIEURS (Rouge)
                        if (lists.over.length > 0) {
                            qualityHTML += `
                                <div style="margin-bottom: 16px;">
                                    <h4 style="color: #dc2626; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 1rem;">
                                        ‚ö†Ô∏è Poids SUP√âRIEURS √† ${maxLimit.toFixed(1)} kg (${lists.over.length})
                                    </h4>
                                    ${lists.over.sort((a, b) => b.totalWeight - a.totalWeight).map(emp => `
                                        <div class="out-of-range-item over-item" style="margin-bottom: 8px;">
                                            <div>
                                                <strong style="font-size: 1.05rem;">${emp.name}</strong>
                                                <div style="color: #64748b; font-size: 0.85rem; margin-top: 2px;">
                                                    ${emp.count} pesage(s)
                                                </div>
                                            </div>
                                            <div style="font-size: 1.3rem; font-weight: 800; color: #dc2626;">
                                                ${emp.totalWeight.toFixed(1)} kg
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }

                        // Liste INF√âRIEURS (Rouge aussi maintenant)
                        if (lists.under.length > 0) {
                            qualityHTML += `
                                <div style="margin-bottom: 16px;">
                                    <h4 style="color: #dc2626; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 1rem;">
                                        ‚ö†Ô∏è Poids INF√âRIEURS √† ${minLimit.toFixed(1)} kg (${lists.under.length})
                                    </h4>
                                    ${lists.under.sort((a, b) => a.totalWeight - b.totalWeight).map(emp => `
                                        <div class="out-of-range-item" style="margin-bottom: 8px; background: rgba(220, 38, 38, 0.08); border: 2px solid rgba(220, 38, 38, 0.2);">
                                            <div>
                                                <strong style="font-size: 1.05rem;">${emp.name}</strong>
                                                <div style="color: #64748b; font-size: 0.85rem; margin-top: 2px;">
                                                    ${emp.count} pesage(s)
                                                </div>
                                            </div>
                                            <div style="font-size: 1.3rem; font-weight: 800; color: #dc2626;">
                                                ${emp.totalWeight.toFixed(1)} kg
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }

                        // Liste VALIDES (Vert)
                        if (lists.inRange.length > 0) {
                            qualityHTML += `
                                <div>
                                    <h4 style="color: #16a34a; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 1rem;">
                                        ‚úÖ Dans les limites (${lists.inRange.length})
                                    </h4>
                                    ${lists.inRange.sort((a, b) => b.totalWeight - a.totalWeight).map(emp => `
                                        <div class="out-of-range-item" style="margin-bottom: 8px; background: rgba(22, 163, 74, 0.08); border: 2px solid rgba(22, 163, 74, 0.2);">
                                            <div>
                                                <strong style="font-size: 1.05rem;">${emp.name}</strong>
                                                <div style="color: #64748b; font-size: 0.85rem; margin-top: 2px;">
                                                    ${emp.count} pesage(s)
                                                </div>
                                            </div>
                                            <div style="font-size: 1.3rem; font-weight: 800; color: #16a34a;">
                                                ${emp.totalWeight.toFixed(1)} kg
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }

                        qualitySection.innerHTML = qualityHTML;
                        outOfRangeLists.appendChild(qualitySection);
                    });
                } else {
                    outOfRangeLists.style.display = 'none';
                }

                // Construire les cartes par qualit√©
                const container = document.getElementById('dailyQualityBreakdown');
                container.innerHTML = '';

                Object.keys(qualityMap).forEach(qualityName => {
                    const data = qualityMap[qualityName];
                    const avgWeight = data.totalWeight / data.count;

                    const sortedEmployees = Object.entries(data.perEmployee)
                        .map(([empId, totalW]) => ({
                            id: parseInt(empId),
                            weight: totalW,
                            name: employees.find(e => e.id === parseInt(empId))?.name || 'Inconnu'
                        }))
                        .sort((a, b) => a.weight - b.weight);

                    if (sortedEmployees.length === 0) return;

                    const top5Min = sortedEmployees.slice(0, 5);
                    const top5Max = sortedEmployees.slice(-5).reverse();

                    let icon = 'üíé';
                    let colorGradient = 'linear-gradient(90deg, #059669, #047857)';
                    let bgColor = 'rgba(5, 150, 105, 0.1)';
                    let textColor = '#059669';
                    let borderColor = 'rgba(5, 150, 105, 0.2)';

                    if (data.price >= 500) {
                        icon = '‚≠ê';
                        colorGradient = 'linear-gradient(90deg, #d97706, #b45309)';
                        bgColor = 'rgba(217, 119, 6, 0.1)';
                        textColor = '#d97706';
                        borderColor = 'rgba(217, 119, 6, 0.2)';
                    } else if (data.price >= 400) {
                        icon = 'üíé';
                    } else if (data.price >= 300) {
                        icon = '‚úì';
                        bgColor = 'rgba(59, 130, 246, 0.1)';
                        textColor = '#3b82f6';
                        borderColor = 'rgba(59, 130, 246, 0.2)';
                    } else if (data.price > 0) {
                        icon = '‚óã';
                        bgColor = 'rgba(100, 116, 139, 0.1)';
                        textColor = '#64748b';
                        borderColor = 'rgba(100, 116, 139, 0.2)';
                    }

                    const card = document.createElement('div');
                    card.className = 'daily-quality-card';
                    card.style.setProperty('--quality-gradient', colorGradient);

                    card.innerHTML = `
                        <div style="margin-bottom: 12px; display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <span class="quality-badge" style="background: ${bgColor}; color: ${textColor}; border-color: ${borderColor};">
                                    ${icon} ${qualityName}
                                </span>
                                <div style="font-weight:700; margin-top:8px;">Total: ${data.totalWeight.toFixed(1)} kg ‚Äî ${data.count} pesage(s)</div>
                                <div style="color:#64748b; margin-top:6px;">Moyenne: ${avgWeight.toFixed(1)} kg</div>
                            </div>
                        </div>

                        <div style="margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <div style="padding:10px; background:white; border-radius:8px; border:1px solid rgba(220,38,38,0.08);">
                                <div style="color:#64748b; font-weight:600;">‚¨áÔ∏è 5 Employ√©s les plus bas</div>
                                ${top5Min.length > 0 ? top5Min.map(emp => `
                                    <div style="font-weight:700; color:#dc2626; margin-top:4px;">${emp.name} ‚Äî ${emp.weight.toFixed(1)} kg</div>
                                `).join('') : '<div style="color:#dc2626;">Aucun</div>'}
                            </div>
                            <div style="padding:10px; background:white; border-radius:8px; border:1px solid rgba(22,163,74,0.08);">
                                <div style="color:#64748b; font-weight:600;">‚¨ÜÔ∏è 5 Employ√©s les plus hauts</div>
                                ${top5Max.length > 0 ? top5Max.map(emp => `
                                    <div style="font-weight:700; color:#16a34a; margin-top:4px;">${emp.name} ‚Äî ${emp.weight.toFixed(1)} kg</div>
                                `).join('') : '<div style="color:#16a34a;">Aucun</div>'}
                            </div>
                        </div>
                    `;

                    container.appendChild(card);
                });

                // Remplir tableau d√©taill√©
                const tbody = document.getElementById('dailyQualityTableBody');
                tbody.innerHTML = '';
                dailyWeights.forEach(w => {
                    const empName = employees.find(e => e.id === w.employeeId)?.name || 'Inconnu';
                    const quality = getQualityName(w);
                    const price = getPriceForWeight(w);
                    const salary = w.weight * price;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-weight:600">${empName}</td>
                        <td>${quality}</td>
                        <td style="font-size: 1.1rem; font-weight: 700;">${w.weight.toFixed(1)} kg</td>
                        <td>${price.toLocaleString('fr-FR')} Ar</td>
                        <td style="font-weight: 700; color: #059669;">${salary.toLocaleString('fr-FR')} Ar</td>
                    `;
                    tbody.appendChild(row);
                });

                applyThousandSeparators();
            }).catch(err => {
                console.error('Erreur updateDailyQualityStats:', err);
                alert('Erreur lors du calcul des statistiques quotidiennes.');
            });
        };

        // ‚≠ê RECHERCHE INTELLIGENTE POUR STATS QUOTIDIENNES
        let dailyStatsSelectedEmployee = null;

        const showDailyStatsEmployeeDropdown = () => {
            if (allEmployees.length === 0) {
                document.getElementById('dailyStatsEmployeeDropdown').innerHTML = 
                    '<div class="employee-option no-results">Aucun employ√© trouv√©</div>';
            } else {
                displayDailyStatsEmployeeOptions(allEmployees);
            }
            document.getElementById('dailyStatsEmployeeDropdown').style.display = 'block';
        };

        const filterDailyStatsByEmployee = () => {
            const searchTerm = document.getElementById('dailyStatsEmployeeSearch').value.toLowerCase();
            const dropdown = document.getElementById('dailyStatsEmployeeDropdown');
            
            if (searchTerm === '') {
                showDailyStatsEmployeeDropdown();
                return;
            }
            
            const filteredEmployees = allEmployees.filter(employee => 
                employee.name.toLowerCase().includes(searchTerm)
            );
            
            displayDailyStatsEmployeeOptions(filteredEmployees);
            dropdown.style.display = 'block';
        };

        const displayDailyStatsEmployeeOptions = (employees) => {
            const dropdown = document.getElementById('dailyStatsEmployeeDropdown');
            
            if (employees.length === 0) {
                dropdown.innerHTML = '<div class="employee-option no-results">Aucun employ√© trouv√©</div>';
            } else {
                dropdown.innerHTML = employees.map((employee) => 
                    `<div class="employee-option" onclick="selectDailyStatsEmployee(${employee.id}, '${employee.name}')">
                        ${employee.name}
                    </div>`
                ).join('');
            }
        };

        const selectDailyStatsEmployee = (id, name) => {
            dailyStatsSelectedEmployee = { id, name };
            document.getElementById('dailyStatsEmployeeSearch').value = name;
            document.getElementById('selectedDailyStatsEmployeeId').value = id;
            document.getElementById('dailyStatsEmployeeDropdown').style.display = 'none';
            
            // Afficher badge
            document.getElementById('selectedEmployeeInfo').style.display = 'block';
            document.getElementById('selectedEmployeeNameDisplay').textContent = name;
            
            // Relancer stats
            updateDailyQualityStats();
        };

        const clearDailyStatsEmployeeFilter = () => {
            dailyStatsSelectedEmployee = null;
            document.getElementById('dailyStatsEmployeeSearch').value = '';
            document.getElementById('selectedDailyStatsEmployeeId').value = '';
            document.getElementById('selectedEmployeeInfo').style.display = 'none';
            document.getElementById('dailyStatsEmployeeDropdown').style.display = 'none';
            
            // Relancer sans filtre
            updateDailyQualityStats();
        };

        // Fermer dropdown si clic dehors
        document.addEventListener('click', (e) => {
            const searchContainer = document.getElementById('dailyStatsEmployeeSearch')?.parentElement;
            const dropdown = document.getElementById('dailyStatsEmployeeDropdown');
            
            if (searchContainer && !searchContainer.contains(e.target)) {
                if (dropdown) dropdown.style.display = 'none';
            }
        });

        // ‚≠ê SYST√àME D'ALERTE EMPLOY√â

        // Ouvrir modal √©dition note
        const editEmployeeNote = (id, name, currentNote) => {
            const newNote = prompt(
                `üìù Note d'alerte pour "${name}"\n\n` +
                `Cette note appara√Ætra automatiquement lors:\n` +
                `‚Ä¢ Enregistrement de pesage\n` +
                `‚Ä¢ Enregistrement de paiement\n\n` +
                `Note actuelle: ${currentNote || '(aucune)'}\n\n` +
                `Nouvelle note (laisser vide pour supprimer):`,
                currentNote || ''
            );
            
            if (newNote === null) return; // Annul√©
            
            const transaction = db.transaction(['employees'], 'readwrite');
            const store = transaction.objectStore('employees');
            
            const request = store.get(id);
            request.onsuccess = () => {
                const employee = request.result;
                if (employee) {
                    employee.alertNote = newNote.trim();
                    employee.updatedAt = new Date().toISOString();
                    
                    const updateRequest = store.put(employee);
                    updateRequest.onsuccess = () => {
                        loadAllEmployees();
                        loadEmployeeManagement();
                        alert(newNote.trim() ? '‚úÖ Note enregistr√©e!' : '‚úÖ Note supprim√©e!');
                    };
                }
            };
        };

        // Afficher alerte si employ√© a une note
        const checkEmployeeAlert = (employeeId, employeeName) => {
            return new Promise((resolve) => {
                const transaction = db.transaction(['employees'], 'readonly');
                const store = transaction.objectStore('employees');
                const request = store.get(employeeId);
                
                request.onsuccess = () => {
                    const employee = request.result;
                    if (employee && employee.alertNote && employee.alertNote.trim() !== '') {
                        showEmployeeAlert(employeeName, employee.alertNote);
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                };
                
                request.onerror = () => resolve(false);
            });
        };

        // Afficher modal alerte
        const showEmployeeAlert = (employeeName, alertNote) => {
            document.getElementById('alertEmployeeName').textContent = employeeName;
            document.getElementById('alertMessageContent').textContent = alertNote;
            document.getElementById('employeeAlertOverlay').style.display = 'block';
            document.getElementById('employeeAlertModal').style.display = 'block';
            
            // Son d'alerte (optionnel)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBzWO1fPTgjMGHm7A7+OZSA0PVq3o7IhLCxNPn9/xvmwhBzWO1fPTgjMGHm7A7+OaRw0QVKzn7I1ODAtNnt/wvmwhBzWO1fPTgjMGHm7A7+OaRw0PVKzn7I1ODAtNnt/wvmwhBzWO1fPTgjMGHm7A7+OaRw0PVKzn7I1ODAtNnt/wvmwhBzWO1fPTgjMGHm7A7+OaRw0PVKzn7I1ODAtNnt/wvmwhBzWO1fPTgjMGHm7A7+OaRw0PVKzn7I1ODAtNnt/wvmwhBzWO1fPTgjMGHm7A7+OaRw0PVKzn7I1ODAtNnt/wvmwhBzWO1fPTgjMGHm7A7+OaRw0PVKzn7I1ODAtNnt/wvmwhBzWO1fPTgjMGHm7A7+OaRw0PVKzn7I1ODAtNnt/wvmwhBzWO1fPTgjMGHm7A7+OaRw0PVKzn7I1ODAtNnt/wvmwhBzWO1fPTgjMGHm7A7+OaRw0PVKzn7I1ODAtNnt/wvmwhBzWO1fPTgjMGHm7A7+OaRw0PVKzn7I1ODAtNnt/wvmwhBzWO1fPTgjMGHm7A7+OaRw0PVKzn7I1ODAtNnt/wvmwhBzWO1fPTgjMGHm7A7+OaRw0PVKzn7I1ODAtNnt/wvmwhBzWO1fPTgjMGHm7A7+OaRw==');
                audio.volume = 0.3;
                audio.play().catch(() => {}); // Ignore si pas autoris√©
            } catch(e) {}
        };

        // Fermer modal
        const closeEmployeeAlert = () => {
            document.getElementById('employeeAlertOverlay').style.display = 'none';
            document.getElementById('employeeAlertModal').style.display = 'none';
        };

        // ‚≠ê NOUVEAU: Afficher les stats d'aujourd'hui
        const showTodayStats = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dailyStatsDate').value = today;
            updateDailyQualityStats();
        };

        
        const toggleDarkMode = () => {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        };

        // Charger au d√©marrage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

    </script>
    <script src="theme.js"></script>
</body>
</html>